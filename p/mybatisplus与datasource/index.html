<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="mybatisplus SQLæ‰§è¡Œæµç¨‹ æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºMybatisSqlSessionFactoryBean mybatis-plus-boot-starteråŒ…æä¾›äº†MybatisPlusAutoConfigurationè‡ªåŠ¨é…ç½®ç±»ï¼Œè¯¥è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºäº†MybatisSqlSessionFactoryBeanå¯¹è±¡å¹¶äº¤ç”±Springç®¡ç†ï¼Œåœ¨åˆ›å»ºMybatisSqlSessionFactoryBeanæ—¶ï¼ŒsqlSessionFactoryæ–¹æ³•è®¾ç½®äº†DataScoureå¯¹è±¡ã€‚è‡ªåŠ¨é…ç½®ç±»éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanï¼š\nMybatisPlusAutoConfigurationä¸Šçš„@ConditionalOnSingleCandidateæŒ‡å®šäº†ï¼šè¢«Springç®¡ç†çš„åªæœ‰ä¸€ä¸ªDataSourceå¯¹è±¡æˆ–è€…å¤šä¸ªDataSourceå¯¹æŒ‡å®šäº†ä¼˜å…ˆçº§ï¼ˆå¦‚é€šè¿‡@Primaryæ³¨è§£æŒ‡å®šï¼‰ sqlSessionFactoryæ–¹æ³•ä¸Š@ConditionalOnMissingBeanæŒ‡å®šäº†ï¼šåªæœ‰åœ¨ä¸å­˜åœ¨SqlSessionFactoryæ—¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanå¯¹è±¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Configuration(proxyBeanMethods = false) @ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class}) @ConditionalOnSingleCandidate(DataSource.class) @EnableConfigurationProperties(MybatisPlusProperties.class) @AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class}) public class MybatisPlusAutoConfiguration implements InitializingBean { @Bean @ConditionalOnMissingBean public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception { // TODO ä½¿ç”¨ MybatisSqlSessionFactoryBean è€Œä¸æ˜¯ SqlSessionFactoryBean MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean(); factory.setDataSource(dataSource); ..... } } Springå¯¹äº‹åŠ¡è¿›è¡Œä»£ç† æ‰§è¡ŒMybatisplus DMLè¯­å¥å‰ï¼ŒSpringå¯¹è¦æ‰§è¡Œçš„æ–¹æ³•ï¼ˆåŠ äº†@Transactiontionalæ³¨è§£ï¼‰è¿›è¡Œä»£ç†ï¼Œä»£ç†æ‰§è¡Œçš„é€»è¾‘åœ¨TransactionAspectSupportä¸­çš„invokeWithinTransactionæ–¹æ³•ä¸­ã€‚æ•´ä½“è°ƒç”¨æµç¨‹å¦‚ä¸‹\n"><title>Mybatisplusä¸DataSource</title><link rel=canonical href=https://zhaoyifengf.github.io/p/mybatisplus%E4%B8%8Edatasource/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Mybatisplusä¸DataSource"><meta property='og:description' content="mybatisplus SQLæ‰§è¡Œæµç¨‹ æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºMybatisSqlSessionFactoryBean mybatis-plus-boot-starteråŒ…æä¾›äº†MybatisPlusAutoConfigurationè‡ªåŠ¨é…ç½®ç±»ï¼Œè¯¥è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºäº†MybatisSqlSessionFactoryBeanå¯¹è±¡å¹¶äº¤ç”±Springç®¡ç†ï¼Œåœ¨åˆ›å»ºMybatisSqlSessionFactoryBeanæ—¶ï¼ŒsqlSessionFactoryæ–¹æ³•è®¾ç½®äº†DataScoureå¯¹è±¡ã€‚è‡ªåŠ¨é…ç½®ç±»éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanï¼š\nMybatisPlusAutoConfigurationä¸Šçš„@ConditionalOnSingleCandidateæŒ‡å®šäº†ï¼šè¢«Springç®¡ç†çš„åªæœ‰ä¸€ä¸ªDataSourceå¯¹è±¡æˆ–è€…å¤šä¸ªDataSourceå¯¹æŒ‡å®šäº†ä¼˜å…ˆçº§ï¼ˆå¦‚é€šè¿‡@Primaryæ³¨è§£æŒ‡å®šï¼‰ sqlSessionFactoryæ–¹æ³•ä¸Š@ConditionalOnMissingBeanæŒ‡å®šäº†ï¼šåªæœ‰åœ¨ä¸å­˜åœ¨SqlSessionFactoryæ—¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanå¯¹è±¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Configuration(proxyBeanMethods = false) @ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class}) @ConditionalOnSingleCandidate(DataSource.class) @EnableConfigurationProperties(MybatisPlusProperties.class) @AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class}) public class MybatisPlusAutoConfiguration implements InitializingBean { @Bean @ConditionalOnMissingBean public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception { // TODO ä½¿ç”¨ MybatisSqlSessionFactoryBean è€Œä¸æ˜¯ SqlSessionFactoryBean MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean(); factory.setDataSource(dataSource); ..... } } Springå¯¹äº‹åŠ¡è¿›è¡Œä»£ç† æ‰§è¡ŒMybatisplus DMLè¯­å¥å‰ï¼ŒSpringå¯¹è¦æ‰§è¡Œçš„æ–¹æ³•ï¼ˆåŠ äº†@Transactiontionalæ³¨è§£ï¼‰è¿›è¡Œä»£ç†ï¼Œä»£ç†æ‰§è¡Œçš„é€»è¾‘åœ¨TransactionAspectSupportä¸­çš„invokeWithinTransactionæ–¹æ³•ä¸­ã€‚æ•´ä½“è°ƒç”¨æµç¨‹å¦‚ä¸‹\n"><meta property='og:url' content='https://zhaoyifengf.github.io/p/mybatisplus%E4%B8%8Edatasource/'><meta property='og:site_name' content='å³°å³°çš„åšå®¢'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Mybatisplus DataSource'><meta property='article:published_time' content='2025-06-23T23:26:52+08:00'><meta property='article:modified_time' content='2025-06-23T23:26:52+08:00'><meta name=twitter:title content="Mybatisplusä¸DataSource"><meta name=twitter:description content="mybatisplus SQLæ‰§è¡Œæµç¨‹ æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºMybatisSqlSessionFactoryBean mybatis-plus-boot-starteråŒ…æä¾›äº†MybatisPlusAutoConfigurationè‡ªåŠ¨é…ç½®ç±»ï¼Œè¯¥è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºäº†MybatisSqlSessionFactoryBeanå¯¹è±¡å¹¶äº¤ç”±Springç®¡ç†ï¼Œåœ¨åˆ›å»ºMybatisSqlSessionFactoryBeanæ—¶ï¼ŒsqlSessionFactoryæ–¹æ³•è®¾ç½®äº†DataScoureå¯¹è±¡ã€‚è‡ªåŠ¨é…ç½®ç±»éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanï¼š\nMybatisPlusAutoConfigurationä¸Šçš„@ConditionalOnSingleCandidateæŒ‡å®šäº†ï¼šè¢«Springç®¡ç†çš„åªæœ‰ä¸€ä¸ªDataSourceå¯¹è±¡æˆ–è€…å¤šä¸ªDataSourceå¯¹æŒ‡å®šäº†ä¼˜å…ˆçº§ï¼ˆå¦‚é€šè¿‡@Primaryæ³¨è§£æŒ‡å®šï¼‰ sqlSessionFactoryæ–¹æ³•ä¸Š@ConditionalOnMissingBeanæŒ‡å®šäº†ï¼šåªæœ‰åœ¨ä¸å­˜åœ¨SqlSessionFactoryæ—¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanå¯¹è±¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Configuration(proxyBeanMethods = false) @ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class}) @ConditionalOnSingleCandidate(DataSource.class) @EnableConfigurationProperties(MybatisPlusProperties.class) @AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class}) public class MybatisPlusAutoConfiguration implements InitializingBean { @Bean @ConditionalOnMissingBean public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception { // TODO ä½¿ç”¨ MybatisSqlSessionFactoryBean è€Œä¸æ˜¯ SqlSessionFactoryBean MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean(); factory.setDataSource(dataSource); ..... } } Springå¯¹äº‹åŠ¡è¿›è¡Œä»£ç† æ‰§è¡ŒMybatisplus DMLè¯­å¥å‰ï¼ŒSpringå¯¹è¦æ‰§è¡Œçš„æ–¹æ³•ï¼ˆåŠ äº†@Transactiontionalæ³¨è§£ï¼‰è¿›è¡Œä»£ç†ï¼Œä»£ç†æ‰§è¡Œçš„é€»è¾‘åœ¨TransactionAspectSupportä¸­çš„invokeWithinTransactionæ–¹æ³•ä¸­ã€‚æ•´ä½“è°ƒç”¨æµç¨‹å¦‚ä¸‹\n"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b6a70ffdce0d98d0.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ®</span></figure><div class=site-meta><h1 class=site-name><a href=/>å³°å³°çš„åšå®¢</a></h1><h2 class=site-description>ä½ å¥½å‘€ï¼Œæœ‹å‹ã€‚</h2></div></header><ol class=menu-social><li><a href=https://github.com/zhaoyifengf target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#mybatisplus-sqlæ‰§è¡Œæµç¨‹>mybatisplus SQLæ‰§è¡Œæµç¨‹</a><ol><li><a href=#æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºmybatissqlsessionfactorybean>æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºMybatisSqlSessionFactoryBean</a></li><li><a href=#springå¯¹äº‹åŠ¡è¿›è¡Œä»£ç†>Springå¯¹äº‹åŠ¡è¿›è¡Œä»£ç†</a></li></ol></li><li><a href=#æ‰§è¡Œmybatisplus-dmlä¸selectè¯­å¥>æ‰§è¡Œmybatisplus DMLä¸Selectè¯­å¥</a></li><li><a href=#datascoureæ•°æ®åº“é“¾æ¥çš„ç®¡ç†è€…>DataScoureï¼šæ•°æ®åº“é“¾æ¥çš„ç®¡ç†è€…</a><ol><li><a href=#è¿æ¥æ± >è¿æ¥æ± </a></li><li><a href=#åŠ¨æ€æ•°æ®æº-å¾…è¡¥å……>åŠ¨æ€æ•°æ®æº (å¾…è¡¥å……)</a><ol><li><a href=#ç¼–è¯‘æ—¶åŠ¨æ€>ç¼–è¯‘æ—¶åŠ¨æ€</a></li><li><a href=#è¿è¡Œæ—¶åŠ¨æ€>è¿è¡Œæ—¶åŠ¨æ€</a></li></ol></li></ol></li><li><a href=#mybatisplus-æ‰§è¡Œ-sqlæ—¶æ•°æ®æºé—®é¢˜æ€»ç»“>mybatisplus æ‰§è¡Œ SQLæ—¶æ•°æ®æºé—®é¢˜æ€»ç»“</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mybatisplus-datasource/>Mybatisplus DataSource</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/mybatisplus%E4%B8%8Edatasource/>Mybatisplusä¸DataSource</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 23, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 8 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h2 id=mybatisplus-sqlæ‰§è¡Œæµç¨‹>mybatisplus SQLæ‰§è¡Œæµç¨‹</h2><h3 id=æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºmybatissqlsessionfactorybean>æœåŠ¡å¯åŠ¨æ—¶é€šè¿‡è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºMybatisSqlSessionFactoryBean</h3><p><code>mybatis-plus-boot-starter</code>åŒ…æä¾›äº†<code>MybatisPlusAutoConfiguration</code>è‡ªåŠ¨é…ç½®ç±»ï¼Œè¯¥è‡ªåŠ¨é…ç½®ç±»åˆ›å»ºäº†MybatisSqlSessionFactoryBeanå¯¹è±¡å¹¶äº¤ç”±Springç®¡ç†ï¼Œåœ¨åˆ›å»ºMybatisSqlSessionFactoryBeanæ—¶ï¼ŒsqlSessionFactoryæ–¹æ³•è®¾ç½®äº†DataScoureå¯¹è±¡ã€‚è‡ªåŠ¨é…ç½®ç±»éœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanï¼š</p><ul><li>MybatisPlusAutoConfigurationä¸Šçš„@ConditionalOnSingleCandidateæŒ‡å®šäº†ï¼šè¢«Springç®¡ç†çš„åªæœ‰ä¸€ä¸ªDataSourceå¯¹è±¡æˆ–è€…å¤šä¸ªDataSourceå¯¹æŒ‡å®šäº†ä¼˜å…ˆçº§ï¼ˆå¦‚é€šè¿‡@Primaryæ³¨è§£æŒ‡å®šï¼‰</li><li>sqlSessionFactoryæ–¹æ³•ä¸Š@ConditionalOnMissingBeanæŒ‡å®šäº†ï¼šåªæœ‰åœ¨ä¸å­˜åœ¨SqlSessionFactoryæ—¶æ‰ä¼šåˆ›å»ºMybatisSqlSessionFactoryBeanå¯¹è±¡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Configuration(proxyBeanMethods = false)
</span></span><span class=line><span class=cl>@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})
</span></span><span class=line><span class=cl>@ConditionalOnSingleCandidate(DataSource.class)
</span></span><span class=line><span class=cl>@EnableConfigurationProperties(MybatisPlusProperties.class)
</span></span><span class=line><span class=cl>@AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class})
</span></span><span class=line><span class=cl>public class MybatisPlusAutoConfiguration implements InitializingBean {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	@Bean
</span></span><span class=line><span class=cl>    @ConditionalOnMissingBean
</span></span><span class=line><span class=cl>    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
</span></span><span class=line><span class=cl>        // TODO ä½¿ç”¨ MybatisSqlSessionFactoryBean è€Œä¸æ˜¯ SqlSessionFactoryBean
</span></span><span class=line><span class=cl>        MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean();
</span></span><span class=line><span class=cl>        factory.setDataSource(dataSource);
</span></span><span class=line><span class=cl>		.....
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=springå¯¹äº‹åŠ¡è¿›è¡Œä»£ç†>Springå¯¹äº‹åŠ¡è¿›è¡Œä»£ç†</h3><p>æ‰§è¡ŒMybatisplus DMLè¯­å¥å‰ï¼ŒSpringå¯¹è¦æ‰§è¡Œçš„æ–¹æ³•ï¼ˆåŠ äº†@Transactiontionalæ³¨è§£ï¼‰è¿›è¡Œä»£ç†ï¼Œä»£ç†æ‰§è¡Œçš„é€»è¾‘åœ¨TransactionAspectSupportä¸­çš„invokeWithinTransactionæ–¹æ³•ä¸­ã€‚æ•´ä½“è°ƒç”¨æµç¨‹å¦‚ä¸‹</p><p>TransactionInterceptor#invoke -> TransactionAspectSupport#invokeWithinTransactionæ‰§è¡Œå¼€å¯äº‹åŠ¡ã€æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€æäº¤äº‹åŠ¡ä¸‰ä¸ªæ­¥éª¤ã€‚</p><ul><li>å¼€å¯äº‹åŠ¡<ul><li>TransactionAspectSupport#invokeWithinTransaction -> determineTransactionManager</li><li>TransactionAspectSupport#determineTransactionManager -> createTransactionIfNecessary</li><li>TransactionAspectSupport#createTransactionIfNecessary -> AbstractPlatformTransactionManager#getTransactionï¼ŒgetTransactionæ–¹æ³•å…ˆå°è¯•è·å–äº‹åŠ¡å†å¼€å¯äº‹åŠ¡ï¼š<ul><li>è·å–äº‹åŠ¡<ul><li>AbstractPlatformTransactionManager#getTransaction -> DataSourceTransactionManager#doGetTransactionï¼ˆdoGetTransactionæ˜¯ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“é€»è¾‘ç”±å®ç°ç±»æä¾›ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåªè®¨è®ºDataSourceTransactionManagerçš„å®ç°é€»è¾‘ï¼‰</li><li>DataSourceTransactionManager#doGetTransactionï¼Œè¯¥æ–¹æ³•åšä¸‹å¦‚ä¸‹æ“ä½œï¼š<ul><li>åˆ›å»ºDataSourceTransactionObjectå¯¹è±¡</li><li>TransactionSynchronizationManager.getResourceæ–¹æ³•è·å–DataSourceTransactionManagerä¸­dataScoureå¯¹è±¡ç»‘å®šçš„ConnectionHolderå¯¹è±¡ï¼ˆç”¨æ¥å­˜å‚¨connectionå¯¹è±¡ï¼‰ã€‚TransactionSynchronizationManagerä¸­ç»´æŠ¤äº†ä¸€ä¸ªThreadLocalå±æ€§resourcesï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥dataScoureå¯¹è±¡ä¸ºkeyã€ConnectionHolderå¯¹è±¡ä¸ºå€¼çš„Mapã€‚TransactionSynchronizationManagerç”¨æ¥ç®¡ç†æ¯ä¸ªçº¿ç¨‹ä¸­å’ŒdataScoureå¯¹è±¡ç»‘å®šçš„connectionå¯¹è±¡ã€‚</li><li>å°†ä¸Šä¸€æ­¥è·å–çš„ConnectionHolderè®¾ç½®åˆ°DataSourceTransactionObjectä¸­</li></ul></li></ul></li><li>å¼€å¯äº‹åŠ¡<ul><li>AbstractPlatformTransactionManager#getTransactio -> DataSourceTransactionManager#startTransaction</li><li>DataSourceTransactionManager#startTransactionn -> doBeginæ–¹æ³•ï¼Œå®ç°å¦‚ä¸‹æ“ä½œï¼ˆDataSourceTransactionManager#doGetTransactionå¯¹è±¡è¿”å›çš„DataSourceTransactionObjectä¸­çš„ConnectionHolderä¸ºç©ºæ—¶æ‰§è¡Œè¯¥æ­¥éª¤ï¼‰ï¼š</li><li>é€šè¿‡DataSourceTransactionManagerä¸­dataScoureå¯¹è±¡è·å–connection</li><li>å°†connectionåŒ…è£…ä¸ºConnectionHolderå¯¹è±¡</li><li>é€šè¿‡TransactionSynchronizationManager.bindResourceå°†ConnectionHolderå¯¹è±¡å’Œconnectionå¯¹è±¡ç»‘å®šå¹¶è®¾ç½®ä¸Šé¢æåˆ°çš„TransactionSynchronizationManagerä¸­çš„ThreadLocalå±æ€§resourcesä¸­</li></ul></li></ul></li></ul></li><li>æ‰§è¡Œä¸šåŠ¡é€»è¾‘<ul><li>TransactionAspectSupport#invokeWithinTransactionæ‰§è¡Œè¢«ä»£ç†æ–¹æ³•ï¼Œmybatisplusä¸­çš„æ–¹æ³•ä¹Ÿä¼šåœ¨åœ¨æ­¤è¢«æ‰§è¡Œï¼Œå…·ä½“æµç¨‹æˆ‘ä»¬æ–¹æ³•ä¸‹ä¸€ä¸ªéƒ¨åˆ†è®¨è®ºã€‚</li></ul></li><li>æäº¤äº‹åŠ¡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;serial&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>TransactionInterceptor</span> <span class=k>extends</span> <span class=n>TransactionAspectSupport</span> <span class=n>implements</span> <span class=n>MethodInterceptor</span><span class=p>,</span> <span class=n>Serializable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Nullable</span>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=ne>Object</span> <span class=n>invoke</span><span class=p>(</span><span class=n>MethodInvocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=n>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>Work</span> <span class=n>out</span> <span class=n>the</span> <span class=n>target</span> <span class=k>class</span><span class=p>:</span> <span class=n>may</span> <span class=n>be</span> <span class=p>{</span><span class=err>@</span><span class=n>code</span> <span class=n>null</span><span class=p>}</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>The</span> <span class=n>TransactionAttributeSource</span> <span class=n>should</span> <span class=n>be</span> <span class=n>passed</span> <span class=n>the</span> <span class=n>target</span> <span class=k>class</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>as</span> <span class=n>well</span> <span class=n>as</span> <span class=n>the</span> <span class=n>method</span><span class=p>,</span> <span class=n>which</span> <span class=n>may</span> <span class=n>be</span> <span class=n>from</span> <span class=n>an</span> <span class=n>interface</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>targetClass</span> <span class=o>=</span> <span class=p>(</span><span class=n>invocation</span><span class=o>.</span><span class=n>getThis</span><span class=p>()</span> <span class=o>!=</span> <span class=n>null</span> <span class=err>?</span> <span class=n>AopUtils</span><span class=o>.</span><span class=n>getTargetClass</span><span class=p>(</span><span class=n>invocation</span><span class=o>.</span><span class=n>getThis</span><span class=p>())</span> <span class=p>:</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>Adapt</span> <span class=n>to</span> <span class=n>TransactionAspectSupport</span><span class=s1>&#39;s invokeWithinTransaction...</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>invokeWithinTransaction</span><span class=p>(</span><span class=n>invocation</span><span class=o>.</span><span class=n>getMethod</span><span class=p>(),</span> <span class=n>targetClass</span><span class=p>,</span> <span class=n>invocation</span><span class=p>::</span><span class=n>proceed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>TransactionAspectSupport</span> <span class=n>implements</span> <span class=n>BeanFactoryAware</span><span class=p>,</span> <span class=n>InitializingBean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Nullable</span>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=ne>Object</span> <span class=n>invokeWithinTransaction</span><span class=p>(</span><span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>targetClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>final</span> <span class=n>InvocationCallback</span> <span class=n>invocation</span><span class=p>)</span> <span class=n>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>If</span> <span class=n>the</span> <span class=n>transaction</span> <span class=n>attribute</span> <span class=n>is</span> <span class=n>null</span><span class=p>,</span> <span class=n>the</span> <span class=n>method</span> <span class=n>is</span> <span class=n>non</span><span class=o>-</span><span class=n>transactional</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=n>TransactionAttributeSource</span> <span class=n>tas</span> <span class=o>=</span> <span class=n>getTransactionAttributeSource</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>final</span> <span class=n>TransactionAttribute</span> <span class=n>txAttr</span> <span class=o>=</span> <span class=p>(</span><span class=n>tas</span> <span class=o>!=</span> <span class=n>null</span> <span class=err>?</span> <span class=n>tas</span><span class=o>.</span><span class=n>getTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>targetClass</span><span class=p>)</span> <span class=p>:</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>final</span> <span class=n>TransactionManager</span> <span class=n>tm</span> <span class=o>=</span> <span class=n>determineTransactionManager</span><span class=p>(</span><span class=n>txAttr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>........</span> <span class=o>//</span> <span class=err>å“åº”å¼äº‹åŠ¡å¤„ç†é€»è¾‘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>PlatformTransactionManager</span> <span class=n>ptm</span> <span class=o>=</span> <span class=n>asPlatformTransactionManager</span><span class=p>(</span><span class=n>tm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>final</span> <span class=ne>String</span> <span class=n>joinpointIdentification</span> <span class=o>=</span> <span class=n>methodIdentification</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>targetClass</span><span class=p>,</span> <span class=n>txAttr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>txAttr</span> <span class=o>==</span> <span class=n>null</span> <span class=o>||</span> <span class=o>!</span><span class=p>(</span><span class=n>ptm</span> <span class=n>instanceof</span> <span class=n>CallbackPreferringPlatformTransactionManager</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>Standard</span> <span class=n>transaction</span> <span class=n>demarcation</span> <span class=n>with</span> <span class=n>getTransaction</span> <span class=ow>and</span> <span class=n>commit</span><span class=o>/</span><span class=n>rollback</span> <span class=n>calls</span><span class=o>.</span>
</span></span><span class=line><span class=cl>			<span class=n>TransactionInfo</span> <span class=n>txInfo</span> <span class=o>=</span> <span class=n>createTransactionIfNecessary</span><span class=p>(</span><span class=n>ptm</span><span class=p>,</span> <span class=n>txAttr</span><span class=p>,</span> <span class=n>joinpointIdentification</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=ne>Object</span> <span class=n>retVal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>This</span> <span class=n>is</span> <span class=n>an</span> <span class=n>around</span> <span class=n>advice</span><span class=p>:</span> <span class=n>Invoke</span> <span class=n>the</span> <span class=n>next</span> <span class=n>interceptor</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>chain</span><span class=o>.</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>This</span> <span class=n>will</span> <span class=n>normally</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>a</span> <span class=n>target</span> <span class=n>object</span> <span class=n>being</span> <span class=n>invoked</span><span class=o>.</span>
</span></span><span class=line><span class=cl>				<span class=n>retVal</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=n>proceedWithInvocation</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>target</span> <span class=n>invocation</span> <span class=n>exception</span>
</span></span><span class=line><span class=cl>				<span class=n>completeTransactionAfterThrowing</span><span class=p>(</span><span class=n>txInfo</span><span class=p>,</span> <span class=n>ex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>throw</span> <span class=n>ex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>cleanupTransactionInfo</span><span class=p>(</span><span class=n>txInfo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>retVal</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>&amp;&amp;</span> <span class=n>vavrPresent</span> <span class=o>&amp;&amp;</span> <span class=n>VavrDelegate</span><span class=o>.</span><span class=n>isVavrTry</span><span class=p>(</span><span class=n>retVal</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>Set</span> <span class=n>rollback</span><span class=o>-</span><span class=n>only</span> <span class=ow>in</span> <span class=k>case</span> <span class=n>of</span> <span class=n>Vavr</span> <span class=n>failure</span> <span class=n>matching</span> <span class=n>our</span> <span class=n>rollback</span> <span class=n>rules</span><span class=o>...</span>
</span></span><span class=line><span class=cl>				<span class=n>TransactionStatus</span> <span class=n>status</span> <span class=o>=</span> <span class=n>txInfo</span><span class=o>.</span><span class=n>getTransactionStatus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>&amp;&amp;</span> <span class=n>txAttr</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>retVal</span> <span class=o>=</span> <span class=n>VavrDelegate</span><span class=o>.</span><span class=n>evaluateTryFailure</span><span class=p>(</span><span class=n>retVal</span><span class=p>,</span> <span class=n>txAttr</span><span class=p>,</span> <span class=n>status</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>commitTransactionAfterReturning</span><span class=p>(</span><span class=n>txInfo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>retVal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span><span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>......</span> <span class=o>//</span> <span class=err>éå›è°ƒäº‹åŠ¡å¤„ç†é€»è¾‘</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=n>TransactionInfo</span> <span class=n>createTransactionIfNecessary</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>PlatformTransactionManager</span> <span class=n>tm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=err>@</span><span class=n>Nullable</span> <span class=n>TransactionAttribute</span> <span class=n>txAttr</span><span class=p>,</span> <span class=n>final</span> <span class=ne>String</span> <span class=n>joinpointIdentification</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...........</span>
</span></span><span class=line><span class=cl>		<span class=n>TransactionStatus</span> <span class=n>status</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>txAttr</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>tm</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>status</span> <span class=o>=</span> <span class=n>tm</span><span class=o>.</span><span class=n>getTransaction</span><span class=p>(</span><span class=n>txAttr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=o>.......</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=o>...........</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>AbstractPlatformTransactionManager</span> <span class=n>implements</span> <span class=n>PlatformTransactionManager</span><span class=p>,</span> <span class=n>Serializable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>final</span> <span class=n>TransactionStatus</span> <span class=n>getTransaction</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>TransactionDefinition</span> <span class=n>definition</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>throws</span> <span class=n>TransactionException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...........................</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=ne>Object</span> <span class=n>transaction</span> <span class=o>=</span> <span class=n>doGetTransaction</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>boolean</span> <span class=n>debugEnabled</span> <span class=o>=</span> <span class=n>logger</span><span class=o>.</span><span class=n>isDebugEnabled</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>No</span> <span class=n>existing</span> <span class=n>transaction</span> <span class=n>found</span> <span class=o>-&gt;</span> <span class=n>check</span> <span class=n>propagation</span> <span class=n>behavior</span> <span class=n>to</span> <span class=n>find</span> <span class=n>out</span> <span class=n>how</span> <span class=n>to</span> <span class=n>proceed</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_MANDATORY</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>.............</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_REQUIRED</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_REQUIRES_NEW</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_NESTED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>SuspendedResourcesHolder</span> <span class=n>suspendedResources</span> <span class=o>=</span> <span class=n>suspend</span><span class=p>(</span><span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=o>...............</span>
</span></span><span class=line><span class=cl>			<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>startTransaction</span><span class=p>(</span><span class=n>def</span><span class=p>,</span> <span class=n>transaction</span><span class=p>,</span> <span class=n>debugEnabled</span><span class=p>,</span> <span class=n>suspendedResources</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>catch</span> <span class=p>(</span><span class=n>RuntimeException</span> <span class=o>|</span> <span class=n>Error</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>.........</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>/**</span>
</span></span><span class=line><span class=cl>	 <span class=o>*</span> <span class=n>Start</span> <span class=n>a</span> <span class=n>new</span> <span class=n>transaction</span><span class=o>.</span>
</span></span><span class=line><span class=cl>	 <span class=o>*/</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>TransactionStatus</span> <span class=n>startTransaction</span><span class=p>(</span><span class=n>TransactionDefinition</span> <span class=n>definition</span><span class=p>,</span> <span class=ne>Object</span> <span class=n>transaction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>boolean</span> <span class=n>debugEnabled</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>SuspendedResourcesHolder</span> <span class=n>suspendedResources</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>boolean</span> <span class=n>newSynchronization</span> <span class=o>=</span> <span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span> <span class=o>!=</span> <span class=n>SYNCHRONIZATION_NEVER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>DefaultTransactionStatus</span> <span class=n>status</span> <span class=o>=</span> <span class=n>newTransactionStatus</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=n>definition</span><span class=p>,</span> <span class=n>transaction</span><span class=p>,</span> <span class=bp>true</span><span class=p>,</span> <span class=n>newSynchronization</span><span class=p>,</span> <span class=n>debugEnabled</span><span class=p>,</span> <span class=n>suspendedResources</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>doBegin</span><span class=p>(</span><span class=n>transaction</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>prepareSynchronization</span><span class=p>(</span><span class=n>status</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DataSourceTransactionManager</span> <span class=k>extends</span> <span class=n>AbstractPlatformTransactionManager</span>
</span></span><span class=line><span class=cl>		<span class=n>implements</span> <span class=n>ResourceTransactionManager</span><span class=p>,</span> <span class=n>InitializingBean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=ne>Object</span> <span class=n>doGetTransaction</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>DataSourceTransactionObject</span> <span class=n>txObject</span> <span class=o>=</span> <span class=n>new</span> <span class=n>DataSourceTransactionObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>txObject</span><span class=o>.</span><span class=n>setSavepointAllowed</span><span class=p>(</span><span class=n>isNestedTransactionAllowed</span><span class=p>());</span>
</span></span><span class=line><span class=cl>		<span class=n>ConnectionHolder</span> <span class=n>conHolder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>				<span class=p>(</span><span class=n>ConnectionHolder</span><span class=p>)</span> <span class=n>TransactionSynchronizationManager</span><span class=o>.</span><span class=n>getResource</span><span class=p>(</span><span class=n>obtainDataSource</span><span class=p>());</span>
</span></span><span class=line><span class=cl>		<span class=n>txObject</span><span class=o>.</span><span class=n>setConnectionHolder</span><span class=p>(</span><span class=n>conHolder</span><span class=p>,</span> <span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>txObject</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=n>void</span> <span class=n>doBegin</span><span class=p>(</span><span class=ne>Object</span> <span class=n>transaction</span><span class=p>,</span> <span class=n>TransactionDefinition</span> <span class=n>definition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>DataSourceTransactionObject</span> <span class=n>txObject</span> <span class=o>=</span> <span class=p>(</span><span class=n>DataSourceTransactionObject</span><span class=p>)</span> <span class=n>transaction</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>Connection</span> <span class=n>con</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>txObject</span><span class=o>.</span><span class=n>hasConnectionHolder</span><span class=p>()</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>					<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>isSynchronizedWithTransaction</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Connection</span> <span class=n>newCon</span> <span class=o>=</span> <span class=n>obtainDataSource</span><span class=p>()</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>logger</span><span class=o>.</span><span class=n>isDebugEnabled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;Acquired Connection [&#34;</span> <span class=o>+</span> <span class=n>newCon</span> <span class=o>+</span> <span class=s2>&#34;] for JDBC transaction&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>setConnectionHolder</span><span class=p>(</span><span class=n>new</span> <span class=n>ConnectionHolder</span><span class=p>(</span><span class=n>newCon</span><span class=p>),</span> <span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>setSynchronizedWithTransaction</span><span class=p>(</span><span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>con</span> <span class=o>=</span> <span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>Integer</span> <span class=n>previousIsolationLevel</span> <span class=o>=</span> <span class=n>DataSourceUtils</span><span class=o>.</span><span class=n>prepareConnectionForTransaction</span><span class=p>(</span><span class=n>con</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>setPreviousIsolationLevel</span><span class=p>(</span><span class=n>previousIsolationLevel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>setReadOnly</span><span class=p>(</span><span class=n>definition</span><span class=o>.</span><span class=n>isReadOnly</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>Switch</span> <span class=n>to</span> <span class=n>manual</span> <span class=n>commit</span> <span class=k>if</span> <span class=n>necessary</span><span class=o>.</span> <span class=n>This</span> <span class=n>is</span> <span class=n>very</span> <span class=n>expensive</span> <span class=ow>in</span> <span class=n>some</span> <span class=n>JDBC</span> <span class=n>drivers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>so</span> <span class=n>we</span> <span class=n>don</span><span class=s1>&#39;t want to do it unnecessarily (for example if we&#39;</span><span class=n>ve</span> <span class=n>explicitly</span>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>configured</span> <span class=n>the</span> <span class=n>connection</span> <span class=n>pool</span> <span class=n>to</span> <span class=n>set</span> <span class=n>it</span> <span class=n>already</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>con</span><span class=o>.</span><span class=n>getAutoCommit</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>setMustRestoreAutoCommit</span><span class=p>(</span><span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>logger</span><span class=o>.</span><span class=n>isDebugEnabled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;Switching JDBC Connection [&#34;</span> <span class=o>+</span> <span class=n>con</span> <span class=o>+</span> <span class=s2>&#34;] to manual commit&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>con</span><span class=o>.</span><span class=n>setAutoCommit</span><span class=p>(</span><span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>prepareTransactionalConnection</span><span class=p>(</span><span class=n>con</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>setTransactionActive</span><span class=p>(</span><span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=ne>int</span> <span class=n>timeout</span> <span class=o>=</span> <span class=n>determineTimeout</span><span class=p>(</span><span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>timeout</span> <span class=o>!=</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>TIMEOUT_DEFAULT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>setTimeoutInSeconds</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>Bind</span> <span class=n>the</span> <span class=n>connection</span> <span class=n>holder</span> <span class=n>to</span> <span class=n>the</span> <span class=n>thread</span><span class=o>.</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>txObject</span><span class=o>.</span><span class=n>isNewConnectionHolder</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>TransactionSynchronizationManager</span><span class=o>.</span><span class=n>bindResource</span><span class=p>(</span><span class=n>obtainDataSource</span><span class=p>(),</span> <span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>());</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>txObject</span><span class=o>.</span><span class=n>isNewConnectionHolder</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>DataSourceUtils</span><span class=o>.</span><span class=n>releaseConnection</span><span class=p>(</span><span class=n>con</span><span class=p>,</span> <span class=n>obtainDataSource</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>setConnectionHolder</span><span class=p>(</span><span class=n>null</span><span class=p>,</span> <span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>throw</span> <span class=n>new</span> <span class=n>CannotCreateTransactionException</span><span class=p>(</span><span class=s2>&#34;Could not open JDBC Connection for transaction&#34;</span><span class=p>,</span> <span class=n>ex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=æ‰§è¡Œmybatisplus-dmlä¸selectè¯­å¥>æ‰§è¡Œmybatisplus DMLä¸Selectè¯­å¥</h2><p>ä»¥è°ƒç”¨IServiceçš„saveBatchæ–¹æ³•ä¸ºä¾‹ï¼Œå…¶æœ€åˆè°ƒç”¨é“¾è·¯å¦‚ä¸‹ServiceImpl#saveBatch -> ServiceImpl#executeBatch -> SqlHelper#executeBatchï¼Œ
æ‰§è¡Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li><p>è·å–SqlSessionFactory</p><p>SqlHelper#executeBatchè°ƒç”¨sqlSessionFactoryæ–¹æ³•ï¼ŒsqlSessionFactoryå¯¹è±¡ä¸­æŒæœ‰DataSourceå¯¹è±¡çš„å¼•ç”¨ã€‚</p></li><li><p>è°ƒç”¨ä¸Šé¢ä¸€æ­¥è·å–çš„SqlSessionFactoryçš„openSessionæ–¹æ³•ï¼ˆè¿™é‡Œä»¥DefaultSqlSessionFactoryåŠ ä»¥è¯´æ˜ï¼‰ï¼Œéœ€è¦æ³¨æ„çš„äº‹è¿™é‡Œçš„Transactionå¯¹è±¡å¹¶ä¸å‚ä¸äº‹åŠ¡çš„æ‰§è¡Œï¼Œåªæ˜¯ç”¨æ¥ç®¡ç†æ•°æ®æºï¼Œè¯¥æ–¹æ³•æ‰§è¡Œäº†å¦‚ä¸‹æ­¥éª¤ï¼š</p><ul><li>åˆ›å»ºTransactionFactoryå¯¹è±¡</li><li>é€šè¿‡TransactionFactoryå¯¹è±¡åˆ›å»ºTransactionå¯¹è±¡ï¼Œå¹¶ä¼ å…¥ä»configureï¼ˆSqlSessionFactoryæŒæœ‰ï¼‰å¯¹è±¡ä¸­è·å–çš„dataScoureå¯¹è±¡</li><li>åˆ›å»ºExecutorå¯¹è±¡å¹¶ä¼ å…¥Transactionå¯¹è±¡</li><li>åˆ›å»ºDefaultSqlSessionå¯¹è±¡å¹¶ä¼ å…¥Executorå¯¹è±¡</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
</span></span><span class=line><span class=cl>  	Transaction tx = null;
</span></span><span class=line><span class=cl>  	try {
</span></span><span class=line><span class=cl>  	final Environment environment = configuration.getEnvironment();
</span></span><span class=line><span class=cl>  	final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);
</span></span><span class=line><span class=cl>  	tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);
</span></span><span class=line><span class=cl>  	final Executor executor = configuration.newExecutor(tx, execType);
</span></span><span class=line><span class=cl>  	return new DefaultSqlSession(configuration, executor, autoCommit);
</span></span><span class=line><span class=cl>  	} catch (Exception e) {
</span></span><span class=line><span class=cl>  	closeTransaction(tx); // may have fetched a connection so lets call close()
</span></span><span class=line><span class=cl>  	throw ExceptionFactory.wrapException(&#34;Error opening session.  Cause: &#34; + e, e);
</span></span><span class=line><span class=cl>  	} finally {
</span></span><span class=line><span class=cl>  	ErrorContext.instance().reset();
</span></span><span class=line><span class=cl>  	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>è°ƒç”¨SqlSessionçš„insertæ–¹æ³•</p><ul><li>è°ƒç”¨é“¾è·¯SqlSession#insert -> SqlSession#update -> BaseExecutor#update -> BatchExecutor#doUpdateï¼ŒBatchExecutor#doUpdateæ‰§è¡Œäº†å¦‚ä¸‹æ­¥éª¤ï¼š<ul><li>è·å–Connectionï¼Œè°ƒç”¨BaseExecutor#getConnection -> Transaction.getConnection -> SpringManagedTransaction.getConnection -> SpringManagedTransaction.openConnection -> DataSourceUtils.getConnection -> DataSourceUtils.doGetConnectionï¼Œä»ä¸‹é¢çš„ä»£ç å¯çŸ¥é“å¦‚æœå½“å‰æ•°æ®æºç»‘å®šäº†Connectionåˆ™è·å–ç»‘å®šçš„Connectionï¼Œå¦‚æœæ²¡æœ‰ç»‘å®šåˆ™è°ƒç”¨DataScoureå¯¹è±¡çš„getConnectionæ–¹æ³•è·å–æ–°çš„connectionæ–¹æ³•</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static Connection doGetConnection(DataSource dataSource) throws SQLException {
</span></span><span class=line><span class=cl>	.......
</span></span><span class=line><span class=cl>	ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);
</span></span><span class=line><span class=cl>	if (conHolder != null &amp;&amp; (conHolder.hasConnection() || conHolder.isSynchronizedWithTransaction())) {
</span></span><span class=line><span class=cl>		conHolder.requested();
</span></span><span class=line><span class=cl>		if (!conHolder.hasConnection()) {
</span></span><span class=line><span class=cl>			logger.debug(&#34;Fetching resumed JDBC Connection from DataSource&#34;);
</span></span><span class=line><span class=cl>			conHolder.setConnection(fetchConnection(dataSource));
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>		return conHolder.getConnection();
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>	// Else we either got no holder or an empty thread-bound holder here.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	logger.debug(&#34;Fetching JDBC Connection from DataSource&#34;);
</span></span><span class=line><span class=cl>	Connection con = fetchConnection(dataSource);
</span></span><span class=line><span class=cl>	........
</span></span><span class=line><span class=cl>	return con;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private static Connection fetchConnection(DataSource dataSource) throws SQLException {
</span></span><span class=line><span class=cl>	Connection con = dataSource.getConnection();
</span></span><span class=line><span class=cl>	if (con == null) {
</span></span><span class=line><span class=cl>		throw new IllegalStateException(&#34;DataSource returned null from getConnection(): &#34; + dataSource);
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>	return con;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><ul><li>å‡†å¤‡Statementï¼Œè®¾ç½®Connectionä¸ºä¸Šä¸€æ­¥è·å–çš„Connection</li><li>æ‰§è¡ŒSQLè¯­å¥</li></ul></li></ul></li></ul><h2 id=datascoureæ•°æ®åº“é“¾æ¥çš„ç®¡ç†è€…>DataScoureï¼šæ•°æ®åº“é“¾æ¥çš„ç®¡ç†è€…</h2><p>ä¸è®ºæ˜¯åœ¨Springäº‹åŠ¡è¿˜æ˜¯mybatisplusæ‰§è¡ŒSQLè¯­å¥å‰è·å–connectionï¼Œéƒ½ä¼šè°ƒç”¨DataScoure#getConnectionæ–¹æ³•ã€‚å¦‚ä¸‹ï¼ŒDataScoureåªæä¾›äº†ä¸¤ä¸ªè·å–connectionæ–¹æ³•ï¼Œç”±æ­¤å¯çŸ¥DataScoureæœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯è¿›è¡ŒConnectionçš„ç®¡ç†ã€‚å¯¹DataSourceçš„getConnectionæ–¹æ³•æä¾›ä¸åŒçš„å®ç°å¯ä»¥æä¾›ä¸åŒçš„åŠŸèƒ½ï¼Œæœ€å…¸å‹çš„è«è¿‡äºè¿æ¥æ± å’ŒåŠ¨æ€æ•°æ®æºã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>interface</span> <span class=n>DataSource</span>  <span class=k>extends</span> <span class=n>CommonDataSource</span><span class=p>,</span> <span class=n>Wrapper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Connection</span> <span class=n>getConnection</span><span class=p>()</span> <span class=n>throws</span> <span class=n>SQLException</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Connection</span> <span class=n>getConnection</span><span class=p>(</span><span class=ne>String</span> <span class=n>username</span><span class=p>,</span> <span class=ne>String</span> <span class=n>password</span><span class=p>)</span> <span class=n>throws</span> <span class=n>SQLException</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=è¿æ¥æ± >è¿æ¥æ± </h3><p>æˆ‘ä»¬ä»¥HikariCPä¸ºä¾‹ï¼Œå…ˆä»‹ç»å…¶åœ¨SpringBooté¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨ï¼Œå†ä»‹ç»å¦‚ä½•é€šè¿‡å…¶è·å–Connection</p><ul><li><p>SpringBooté›†æˆHikariCP</p><ul><li>yamlé…ç½®</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>spring:
</span></span><span class=line><span class=cl>	datasource:
</span></span><span class=line><span class=cl>	type: com.zaxxer.hikari.HikariDataSource
</span></span><span class=line><span class=cl>	url: jdbc:mysql://localhost:3306/test?useSSL=false
</span></span><span class=line><span class=cl>	username: root
</span></span><span class=line><span class=cl>	password: 123456
</span></span><span class=line><span class=cl>	driver-class-name: com.mysql.cj.jdbc.Driver
</span></span><span class=line><span class=cl>	hikari:
</span></span><span class=line><span class=cl>		pool-name: MyHikariCP
</span></span><span class=line><span class=cl>		minimum-idle: 5
</span></span><span class=line><span class=cl>		maximum-pool-size: 20
</span></span><span class=line><span class=cl>		idle-timeout: 600000
</span></span><span class=line><span class=cl>		max-lifetime: 1800000
</span></span><span class=line><span class=cl>		connection-timeout: 30000
</span></span><span class=line><span class=cl>		connection-test-query: SELECT 1
</span></span></code></pre></td></tr></table></div></div><ul><li>æ•°æ®æºå±æ€§ç±»</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>ConfigurationProperties</span><span class=p>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s2>&#34;spring.datasource&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DataSourceProperties</span> <span class=n>implements</span> <span class=n>BeanClassLoaderAware</span><span class=p>,</span> <span class=n>InitializingBean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>boolean</span> <span class=n>generateUniqueName</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>DataSource</span><span class=o>&gt;</span> <span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>driverClassName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>Springbootè‡ªåŠ¨é…ç½®</p><p>å½“æˆ‘ä»¬åœ¨yamlæ–‡ä»¶ä¸­æŒ‡å®šäº†<code>type: com.zaxxer.hikari.HikariDataSource</code>æ»¡è¶³äº†è‡ªåŠ¨é…ç½®ç±»<code>@ConditionalOnProperty(name = "spring.datasource.type", havingValue = "com.zaxxer.hikari.HikariDataSource",matchIfMissing = true)</code>çš„æ¡ä»¶ï¼Œåˆ›å»ºHikariDataSourceå¯¹è±¡å¹¶äº¤ç”±Springç®¡ç†ã€‚</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>stract class DataSourceConfiguration {
</span></span><span class=line><span class=cl>	@Configuration(proxyBeanMethods = false)
</span></span><span class=line><span class=cl>	@ConditionalOnClass(HikariDataSource.class)
</span></span><span class=line><span class=cl>	@ConditionalOnMissingBean(DataSource.class)
</span></span><span class=line><span class=cl>	@ConditionalOnProperty(name = &#34;spring.datasource.type&#34;, havingValue = &#34;com.zaxxer.hikari.HikariDataSource&#34;,
</span></span><span class=line><span class=cl>			matchIfMissing = true)
</span></span><span class=line><span class=cl>	static class Hikari {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		@Bean
</span></span><span class=line><span class=cl>		@ConfigurationProperties(prefix = &#34;spring.datasource.hikari&#34;)
</span></span><span class=line><span class=cl>		HikariDataSource dataSource(DataSourceProperties properties) {
</span></span><span class=line><span class=cl>			HikariDataSource dataSource = createDataSource(properties, HikariDataSource.class);
</span></span><span class=line><span class=cl>			if (StringUtils.hasText(properties.getName())) {
</span></span><span class=line><span class=cl>				dataSource.setPoolName(properties.getName());
</span></span><span class=line><span class=cl>			}
</span></span><span class=line><span class=cl>			return dataSource;
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>HikariDataSourceå®ç°æ•°æ®åº“é“¾æ¥ç®¡ç†
åœ¨æ²¡æœ‰åˆ›å»ºå…¶ä»–æ•°æ®æºçš„æƒ…å†µä¸‹ï¼ŒHikariDataSourceä¼šè¢«æ³¨å…¥Mybatisplusçš„MybatisSqlSessionFactoryBeanå¹¶åœ¨æ‰§è¡ŒSQLè¯­å¥å‰è¢«è·å–ï¼ŒHikariDataSourceåªéœ€è¦é‡å†™getConnectionæ–¹æ³•å°±å¯å®ç°å¯¹æ•°æ®åº“è¿æ¥çš„ç®¡ç†ã€‚å¦‚ä¸‹ä»£ç ï¼ŒHikariDataSourceè·å–æ•°æ®åº“è¿æ¥çš„åŠŸèƒ½æœ€ç»ˆå§”æ‰˜ç»™äº†HikariPoolã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>HikariDataSource</span> <span class=k>extends</span> <span class=n>HikariConfig</span> <span class=n>implements</span> <span class=n>DataSource</span><span class=p>,</span> <span class=n>Closeable</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=k>static</span> <span class=n>final</span> <span class=n>Logger</span> <span class=n>LOGGER</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>HikariDataSource</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>final</span> <span class=n>AtomicBoolean</span> <span class=n>isShutdown</span> <span class=o>=</span> <span class=n>new</span> <span class=n>AtomicBoolean</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>final</span> <span class=n>HikariPool</span> <span class=n>fastPathPool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>volatile</span> <span class=n>HikariPool</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>HikariDataSource</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>super</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>fastPathPool</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>HikariConfig</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>configuration</span><span class=o>.</span><span class=n>validate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>configuration</span><span class=o>.</span><span class=n>copyStateTo</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Starting...&#34;</span><span class=p>,</span> <span class=n>configuration</span><span class=o>.</span><span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>		<span class=n>pool</span> <span class=o>=</span> <span class=n>fastPathPool</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HikariPool</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Start completed.&#34;</span><span class=p>,</span> <span class=n>configuration</span><span class=o>.</span><span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>this</span><span class=o>.</span><span class=n>seal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>Connection</span> <span class=n>getConnection</span><span class=p>()</span> <span class=n>throws</span> <span class=n>SQLException</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>isClosed</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>throw</span> <span class=n>new</span> <span class=n>SQLException</span><span class=p>(</span><span class=s2>&#34;HikariDataSource &#34;</span> <span class=o>+</span> <span class=n>this</span> <span class=o>+</span> <span class=s2>&#34; has been closed.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>fastPathPool</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>fastPathPool</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>See</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>en</span><span class=o>.</span><span class=n>wikipedia</span><span class=o>.</span><span class=n>org</span><span class=o>/</span><span class=n>wiki</span><span class=o>/</span><span class=n>Double</span><span class=o>-</span><span class=n>checked_locking</span><span class=c1>#Usage_in_Java</span>
</span></span><span class=line><span class=cl>		<span class=n>HikariPool</span> <span class=n>result</span> <span class=o>=</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>synchronized</span> <span class=p>(</span><span class=n>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>result</span> <span class=o>=</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>validate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Starting...&#34;</span><span class=p>,</span> <span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>pool</span> <span class=o>=</span> <span class=n>result</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HikariPool</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>this</span><span class=o>.</span><span class=n>seal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>catch</span> <span class=p>(</span><span class=n>PoolInitializationException</span> <span class=n>pie</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=n>pie</span><span class=o>.</span><span class=n>getCause</span><span class=p>()</span> <span class=n>instanceof</span> <span class=n>SQLException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=n>throw</span> <span class=p>(</span><span class=n>SQLException</span><span class=p>)</span> <span class=n>pie</span><span class=o>.</span><span class=n>getCause</span><span class=p>();</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=n>throw</span> <span class=n>pie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Start completed.&#34;</span><span class=p>,</span> <span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>HikariPoolæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼Œ</p></li></ul><img src=HikariDataSource.svg width=90% height=90%><h3 id=åŠ¨æ€æ•°æ®æº-å¾…è¡¥å……>åŠ¨æ€æ•°æ®æº (å¾…è¡¥å……)</h3><h4 id=ç¼–è¯‘æ—¶åŠ¨æ€>ç¼–è¯‘æ—¶åŠ¨æ€</h4><h4 id=è¿è¡Œæ—¶åŠ¨æ€>è¿è¡Œæ—¶åŠ¨æ€</h4><h2 id=mybatisplus-æ‰§è¡Œ-sqlæ—¶æ•°æ®æºé—®é¢˜æ€»ç»“>mybatisplus æ‰§è¡Œ SQLæ—¶æ•°æ®æºé—®é¢˜æ€»ç»“</h2><ul><li>æ•°æ®æºDataScoureæ˜¯ä¸€ä¸ªç®¡ç†æ•°æ®åº“è¿æ¥çš„å¯¹è±¡ï¼Œå®ƒä¸æ•°æ®åº“è¿æ¥æ˜¯ä¸€å¯¹å¤šçš„å…³è”</li><li>mybatisplusçš„æ•°æ®æºå¯¹è±¡å–è‡ªSqlSessionFactoryå¯¹è±¡ï¼Œåœ¨æ»¡è¶³ç¬¬ä¸€èŠ‚Mybatisplusè‡ªåŠ¨é…ç½®MybatisSqlSessionFactoryBeançš„æ¡ä»¶ä¸‹ï¼Œmybatisplusè·å–çš„æ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„ï¼ˆåŠ äº†@Primaryï¼‰DataScoureå¯¹è±¡</li><li>æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨çš„æ•°æ®æºåªä¼šå½±å“@Transactionalæ³¨è§£ç»‘å®šDatasourceå¯¹è±¡å’ŒConnectionæ–¹æ³•çš„é€»è¾‘ï¼Œå¹¶ä¸ä¼šå½±å“mybatispluså®é™…è·å–çš„æ•°æ®æºï¼ˆmybatisplusä»SqlSessionFactoryä¸­å–æ•°æ®æºï¼‰</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/mybatisplus-datasource/>Mybatisplus DataSource</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 å³°å³°</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
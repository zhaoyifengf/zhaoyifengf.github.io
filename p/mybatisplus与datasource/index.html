<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="mybatisplus SQL执行流程 服务启动时通过自动配置类创建MybatisSqlSessionFactoryBean mybatis-plus-boot-starter包提供了MybatisPlusAutoConfiguration自动配置类，该自动配置类创建了MybatisSqlSessionFactoryBean对象并交由Spring管理，在创建MybatisSqlSessionFactoryBean时，sqlSessionFactory方法设置了DataScoure对象。自动配置类需要满足以下几个条件才会创建MybatisSqlSessionFactoryBean：\nMybatisPlusAutoConfiguration上的@ConditionalOnSingleCandidate指定了：被Spring管理的只有一个DataSource对象或者多个DataSource对指定了优先级（如通过@Primary注解指定） sqlSessionFactory方法上@ConditionalOnMissingBean指定了：只有在不存在SqlSessionFactory时才会创建MybatisSqlSessionFactoryBean对象 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Configuration(proxyBeanMethods = false) @ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class}) @ConditionalOnSingleCandidate(DataSource.class) @EnableConfigurationProperties(MybatisPlusProperties.class) @AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class}) public class MybatisPlusAutoConfiguration implements InitializingBean { @Bean @ConditionalOnMissingBean public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception { // TODO 使用 MybatisSqlSessionFactoryBean 而不是 SqlSessionFactoryBean MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean(); factory.setDataSource(dataSource); ..... } } Spring对事务进行代理 执行Mybatisplus DML语句前，Spring对要执行的方法（加了@Transactiontional注解）进行代理，代理执行的逻辑在TransactionAspectSupport中的invokeWithinTransaction方法中。整体调用流程如下\n"><title>Mybatisplus与DataSource</title><link rel=canonical href=https://zhaoyifengf.github.io/p/mybatisplus%E4%B8%8Edatasource/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="Mybatisplus与DataSource"><meta property='og:description' content="mybatisplus SQL执行流程 服务启动时通过自动配置类创建MybatisSqlSessionFactoryBean mybatis-plus-boot-starter包提供了MybatisPlusAutoConfiguration自动配置类，该自动配置类创建了MybatisSqlSessionFactoryBean对象并交由Spring管理，在创建MybatisSqlSessionFactoryBean时，sqlSessionFactory方法设置了DataScoure对象。自动配置类需要满足以下几个条件才会创建MybatisSqlSessionFactoryBean：\nMybatisPlusAutoConfiguration上的@ConditionalOnSingleCandidate指定了：被Spring管理的只有一个DataSource对象或者多个DataSource对指定了优先级（如通过@Primary注解指定） sqlSessionFactory方法上@ConditionalOnMissingBean指定了：只有在不存在SqlSessionFactory时才会创建MybatisSqlSessionFactoryBean对象 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Configuration(proxyBeanMethods = false) @ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class}) @ConditionalOnSingleCandidate(DataSource.class) @EnableConfigurationProperties(MybatisPlusProperties.class) @AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class}) public class MybatisPlusAutoConfiguration implements InitializingBean { @Bean @ConditionalOnMissingBean public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception { // TODO 使用 MybatisSqlSessionFactoryBean 而不是 SqlSessionFactoryBean MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean(); factory.setDataSource(dataSource); ..... } } Spring对事务进行代理 执行Mybatisplus DML语句前，Spring对要执行的方法（加了@Transactiontional注解）进行代理，代理执行的逻辑在TransactionAspectSupport中的invokeWithinTransaction方法中。整体调用流程如下\n"><meta property='og:url' content='https://zhaoyifengf.github.io/p/mybatisplus%E4%B8%8Edatasource/'><meta property='og:site_name' content='峰峰的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Mybatisplus DataSource'><meta property='article:published_time' content='2025-06-23T23:26:52+08:00'><meta property='article:modified_time' content='2025-06-23T23:26:52+08:00'><meta name=twitter:title content="Mybatisplus与DataSource"><meta name=twitter:description content="mybatisplus SQL执行流程 服务启动时通过自动配置类创建MybatisSqlSessionFactoryBean mybatis-plus-boot-starter包提供了MybatisPlusAutoConfiguration自动配置类，该自动配置类创建了MybatisSqlSessionFactoryBean对象并交由Spring管理，在创建MybatisSqlSessionFactoryBean时，sqlSessionFactory方法设置了DataScoure对象。自动配置类需要满足以下几个条件才会创建MybatisSqlSessionFactoryBean：\nMybatisPlusAutoConfiguration上的@ConditionalOnSingleCandidate指定了：被Spring管理的只有一个DataSource对象或者多个DataSource对指定了优先级（如通过@Primary注解指定） sqlSessionFactory方法上@ConditionalOnMissingBean指定了：只有在不存在SqlSessionFactory时才会创建MybatisSqlSessionFactoryBean对象 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 @Configuration(proxyBeanMethods = false) @ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class}) @ConditionalOnSingleCandidate(DataSource.class) @EnableConfigurationProperties(MybatisPlusProperties.class) @AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class}) public class MybatisPlusAutoConfiguration implements InitializingBean { @Bean @ConditionalOnMissingBean public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception { // TODO 使用 MybatisSqlSessionFactoryBean 而不是 SqlSessionFactoryBean MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean(); factory.setDataSource(dataSource); ..... } } Spring对事务进行代理 执行Mybatisplus DML语句前，Spring对要执行的方法（加了@Transactiontional注解）进行代理，代理执行的逻辑在TransactionAspectSupport中的invokeWithinTransaction方法中。整体调用流程如下\n"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_b6a70ffdce0d98d0.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🐮</span></figure><div class=site-meta><h1 class=site-name><a href=/>峰峰的博客</a></h1><h2 class=site-description>你好呀，朋友。</h2></div></header><ol class=menu-social><li><a href=https://github.com/zhaoyifengf target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#mybatisplus-sql执行流程>mybatisplus SQL执行流程</a><ol><li><a href=#服务启动时通过自动配置类创建mybatissqlsessionfactorybean>服务启动时通过自动配置类创建MybatisSqlSessionFactoryBean</a></li><li><a href=#spring对事务进行代理>Spring对事务进行代理</a></li></ol></li><li><a href=#执行mybatisplus-dml与select语句>执行mybatisplus DML与Select语句</a></li><li><a href=#datascoure数据库链接的管理者>DataScoure：数据库链接的管理者</a><ol><li><a href=#连接池>连接池</a></li><li><a href=#动态数据源-待补充>动态数据源 (待补充)</a><ol><li><a href=#编译时动态>编译时动态</a></li><li><a href=#运行时动态>运行时动态</a></li></ol></li></ol></li><li><a href=#mybatisplus-执行-sql时数据源问题总结>mybatisplus 执行 SQL时数据源问题总结</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mybatisplus-datasource/>Mybatisplus DataSource</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/mybatisplus%E4%B8%8Edatasource/>Mybatisplus与DataSource</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 23, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 8 分钟</time></div></footer></div></header><section class=article-content><h2 id=mybatisplus-sql执行流程>mybatisplus SQL执行流程</h2><h3 id=服务启动时通过自动配置类创建mybatissqlsessionfactorybean>服务启动时通过自动配置类创建MybatisSqlSessionFactoryBean</h3><p><code>mybatis-plus-boot-starter</code>包提供了<code>MybatisPlusAutoConfiguration</code>自动配置类，该自动配置类创建了MybatisSqlSessionFactoryBean对象并交由Spring管理，在创建MybatisSqlSessionFactoryBean时，sqlSessionFactory方法设置了DataScoure对象。自动配置类需要满足以下几个条件才会创建MybatisSqlSessionFactoryBean：</p><ul><li>MybatisPlusAutoConfiguration上的@ConditionalOnSingleCandidate指定了：被Spring管理的只有一个DataSource对象或者多个DataSource对指定了优先级（如通过@Primary注解指定）</li><li>sqlSessionFactory方法上@ConditionalOnMissingBean指定了：只有在不存在SqlSessionFactory时才会创建MybatisSqlSessionFactoryBean对象</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@Configuration(proxyBeanMethods = false)
</span></span><span class=line><span class=cl>@ConditionalOnClass({SqlSessionFactory.class, SqlSessionFactoryBean.class})
</span></span><span class=line><span class=cl>@ConditionalOnSingleCandidate(DataSource.class)
</span></span><span class=line><span class=cl>@EnableConfigurationProperties(MybatisPlusProperties.class)
</span></span><span class=line><span class=cl>@AutoConfigureAfter({DataSourceAutoConfiguration.class, MybatisPlusLanguageDriverAutoConfiguration.class})
</span></span><span class=line><span class=cl>public class MybatisPlusAutoConfiguration implements InitializingBean {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	@Bean
</span></span><span class=line><span class=cl>    @ConditionalOnMissingBean
</span></span><span class=line><span class=cl>    public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
</span></span><span class=line><span class=cl>        // TODO 使用 MybatisSqlSessionFactoryBean 而不是 SqlSessionFactoryBean
</span></span><span class=line><span class=cl>        MybatisSqlSessionFactoryBean factory = new MybatisSqlSessionFactoryBean();
</span></span><span class=line><span class=cl>        factory.setDataSource(dataSource);
</span></span><span class=line><span class=cl>		.....
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=spring对事务进行代理>Spring对事务进行代理</h3><p>执行Mybatisplus DML语句前，Spring对要执行的方法（加了@Transactiontional注解）进行代理，代理执行的逻辑在TransactionAspectSupport中的invokeWithinTransaction方法中。整体调用流程如下</p><p>TransactionInterceptor#invoke -> TransactionAspectSupport#invokeWithinTransaction执行开启事务、执行业务逻辑、提交事务三个步骤。</p><ul><li>开启事务<ul><li>TransactionAspectSupport#invokeWithinTransaction -> determineTransactionManager</li><li>TransactionAspectSupport#determineTransactionManager -> createTransactionIfNecessary</li><li>TransactionAspectSupport#createTransactionIfNecessary -> AbstractPlatformTransactionManager#getTransaction，getTransaction方法先尝试获取事务再开启事务：<ul><li>获取事务<ul><li>AbstractPlatformTransactionManager#getTransaction -> DataSourceTransactionManager#doGetTransaction（doGetTransaction是个抽象方法，具体逻辑由实现类提供，我们在这里只讨论DataSourceTransactionManager的实现逻辑）</li><li>DataSourceTransactionManager#doGetTransaction，该方法做下如下操作：<ul><li>创建DataSourceTransactionObject对象</li><li>TransactionSynchronizationManager.getResource方法获取DataSourceTransactionManager中dataScoure对象绑定的ConnectionHolder对象（用来存储connection对象）。TransactionSynchronizationManager中维护了一个ThreadLocal属性resources，这是一个以dataScoure对象为key、ConnectionHolder对象为值的Map。TransactionSynchronizationManager用来管理每个线程中和dataScoure对象绑定的connection对象。</li><li>将上一步获取的ConnectionHolder设置到DataSourceTransactionObject中</li></ul></li></ul></li><li>开启事务<ul><li>AbstractPlatformTransactionManager#getTransactio -> DataSourceTransactionManager#startTransaction</li><li>DataSourceTransactionManager#startTransactionn -> doBegin方法，实现如下操作（DataSourceTransactionManager#doGetTransaction对象返回的DataSourceTransactionObject中的ConnectionHolder为空时执行该步骤）：</li><li>通过DataSourceTransactionManager中dataScoure对象获取connection</li><li>将connection包装为ConnectionHolder对象</li><li>通过TransactionSynchronizationManager.bindResource将ConnectionHolder对象和connection对象绑定并设置上面提到的TransactionSynchronizationManager中的ThreadLocal属性resources中</li></ul></li></ul></li></ul></li><li>执行业务逻辑<ul><li>TransactionAspectSupport#invokeWithinTransaction执行被代理方法，mybatisplus中的方法也会在在此被执行，具体流程我们方法下一个部分讨论。</li></ul></li><li>提交事务</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>SuppressWarnings</span><span class=p>(</span><span class=s2>&#34;serial&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>TransactionInterceptor</span> <span class=k>extends</span> <span class=n>TransactionAspectSupport</span> <span class=n>implements</span> <span class=n>MethodInterceptor</span><span class=p>,</span> <span class=n>Serializable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Nullable</span>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=ne>Object</span> <span class=n>invoke</span><span class=p>(</span><span class=n>MethodInvocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=n>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>Work</span> <span class=n>out</span> <span class=n>the</span> <span class=n>target</span> <span class=k>class</span><span class=p>:</span> <span class=n>may</span> <span class=n>be</span> <span class=p>{</span><span class=err>@</span><span class=n>code</span> <span class=n>null</span><span class=p>}</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>The</span> <span class=n>TransactionAttributeSource</span> <span class=n>should</span> <span class=n>be</span> <span class=n>passed</span> <span class=n>the</span> <span class=n>target</span> <span class=k>class</span>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>as</span> <span class=n>well</span> <span class=n>as</span> <span class=n>the</span> <span class=n>method</span><span class=p>,</span> <span class=n>which</span> <span class=n>may</span> <span class=n>be</span> <span class=n>from</span> <span class=n>an</span> <span class=n>interface</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>targetClass</span> <span class=o>=</span> <span class=p>(</span><span class=n>invocation</span><span class=o>.</span><span class=n>getThis</span><span class=p>()</span> <span class=o>!=</span> <span class=n>null</span> <span class=err>?</span> <span class=n>AopUtils</span><span class=o>.</span><span class=n>getTargetClass</span><span class=p>(</span><span class=n>invocation</span><span class=o>.</span><span class=n>getThis</span><span class=p>())</span> <span class=p>:</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>Adapt</span> <span class=n>to</span> <span class=n>TransactionAspectSupport</span><span class=s1>&#39;s invokeWithinTransaction...</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>invokeWithinTransaction</span><span class=p>(</span><span class=n>invocation</span><span class=o>.</span><span class=n>getMethod</span><span class=p>(),</span> <span class=n>targetClass</span><span class=p>,</span> <span class=n>invocation</span><span class=p>::</span><span class=n>proceed</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>TransactionAspectSupport</span> <span class=n>implements</span> <span class=n>BeanFactoryAware</span><span class=p>,</span> <span class=n>InitializingBean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Nullable</span>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=ne>Object</span> <span class=n>invokeWithinTransaction</span><span class=p>(</span><span class=n>Method</span> <span class=n>method</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span><span class=o>&gt;</span> <span class=n>targetClass</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>final</span> <span class=n>InvocationCallback</span> <span class=n>invocation</span><span class=p>)</span> <span class=n>throws</span> <span class=n>Throwable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>If</span> <span class=n>the</span> <span class=n>transaction</span> <span class=n>attribute</span> <span class=n>is</span> <span class=n>null</span><span class=p>,</span> <span class=n>the</span> <span class=n>method</span> <span class=n>is</span> <span class=n>non</span><span class=o>-</span><span class=n>transactional</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=n>TransactionAttributeSource</span> <span class=n>tas</span> <span class=o>=</span> <span class=n>getTransactionAttributeSource</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>final</span> <span class=n>TransactionAttribute</span> <span class=n>txAttr</span> <span class=o>=</span> <span class=p>(</span><span class=n>tas</span> <span class=o>!=</span> <span class=n>null</span> <span class=err>?</span> <span class=n>tas</span><span class=o>.</span><span class=n>getTransactionAttribute</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>targetClass</span><span class=p>)</span> <span class=p>:</span> <span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>final</span> <span class=n>TransactionManager</span> <span class=n>tm</span> <span class=o>=</span> <span class=n>determineTransactionManager</span><span class=p>(</span><span class=n>txAttr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>........</span> <span class=o>//</span> <span class=err>响应式事务处理逻辑</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>PlatformTransactionManager</span> <span class=n>ptm</span> <span class=o>=</span> <span class=n>asPlatformTransactionManager</span><span class=p>(</span><span class=n>tm</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>final</span> <span class=ne>String</span> <span class=n>joinpointIdentification</span> <span class=o>=</span> <span class=n>methodIdentification</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>targetClass</span><span class=p>,</span> <span class=n>txAttr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>txAttr</span> <span class=o>==</span> <span class=n>null</span> <span class=o>||</span> <span class=o>!</span><span class=p>(</span><span class=n>ptm</span> <span class=n>instanceof</span> <span class=n>CallbackPreferringPlatformTransactionManager</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>Standard</span> <span class=n>transaction</span> <span class=n>demarcation</span> <span class=n>with</span> <span class=n>getTransaction</span> <span class=ow>and</span> <span class=n>commit</span><span class=o>/</span><span class=n>rollback</span> <span class=n>calls</span><span class=o>.</span>
</span></span><span class=line><span class=cl>			<span class=n>TransactionInfo</span> <span class=n>txInfo</span> <span class=o>=</span> <span class=n>createTransactionIfNecessary</span><span class=p>(</span><span class=n>ptm</span><span class=p>,</span> <span class=n>txAttr</span><span class=p>,</span> <span class=n>joinpointIdentification</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=ne>Object</span> <span class=n>retVal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>This</span> <span class=n>is</span> <span class=n>an</span> <span class=n>around</span> <span class=n>advice</span><span class=p>:</span> <span class=n>Invoke</span> <span class=n>the</span> <span class=n>next</span> <span class=n>interceptor</span> <span class=ow>in</span> <span class=n>the</span> <span class=n>chain</span><span class=o>.</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>This</span> <span class=n>will</span> <span class=n>normally</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>a</span> <span class=n>target</span> <span class=n>object</span> <span class=n>being</span> <span class=n>invoked</span><span class=o>.</span>
</span></span><span class=line><span class=cl>				<span class=n>retVal</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=n>proceedWithInvocation</span><span class=p>();</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>target</span> <span class=n>invocation</span> <span class=n>exception</span>
</span></span><span class=line><span class=cl>				<span class=n>completeTransactionAfterThrowing</span><span class=p>(</span><span class=n>txInfo</span><span class=p>,</span> <span class=n>ex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=n>throw</span> <span class=n>ex</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>cleanupTransactionInfo</span><span class=p>(</span><span class=n>txInfo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>retVal</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>&amp;&amp;</span> <span class=n>vavrPresent</span> <span class=o>&amp;&amp;</span> <span class=n>VavrDelegate</span><span class=o>.</span><span class=n>isVavrTry</span><span class=p>(</span><span class=n>retVal</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=o>//</span> <span class=n>Set</span> <span class=n>rollback</span><span class=o>-</span><span class=n>only</span> <span class=ow>in</span> <span class=k>case</span> <span class=n>of</span> <span class=n>Vavr</span> <span class=n>failure</span> <span class=n>matching</span> <span class=n>our</span> <span class=n>rollback</span> <span class=n>rules</span><span class=o>...</span>
</span></span><span class=line><span class=cl>				<span class=n>TransactionStatus</span> <span class=n>status</span> <span class=o>=</span> <span class=n>txInfo</span><span class=o>.</span><span class=n>getTransactionStatus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>null</span> <span class=o>&amp;&amp;</span> <span class=n>txAttr</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>retVal</span> <span class=o>=</span> <span class=n>VavrDelegate</span><span class=o>.</span><span class=n>evaluateTryFailure</span><span class=p>(</span><span class=n>retVal</span><span class=p>,</span> <span class=n>txAttr</span><span class=p>,</span> <span class=n>status</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>commitTransactionAfterReturning</span><span class=p>(</span><span class=n>txInfo</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>retVal</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span><span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>......</span> <span class=o>//</span> <span class=err>非回调事务处理逻辑</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=n>TransactionInfo</span> <span class=n>createTransactionIfNecessary</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>PlatformTransactionManager</span> <span class=n>tm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=err>@</span><span class=n>Nullable</span> <span class=n>TransactionAttribute</span> <span class=n>txAttr</span><span class=p>,</span> <span class=n>final</span> <span class=ne>String</span> <span class=n>joinpointIdentification</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...........</span>
</span></span><span class=line><span class=cl>		<span class=n>TransactionStatus</span> <span class=n>status</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>txAttr</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>tm</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>status</span> <span class=o>=</span> <span class=n>tm</span><span class=o>.</span><span class=n>getTransaction</span><span class=p>(</span><span class=n>txAttr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=o>.......</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=o>...........</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=n>abstract</span> <span class=k>class</span> <span class=n>AbstractPlatformTransactionManager</span> <span class=n>implements</span> <span class=n>PlatformTransactionManager</span><span class=p>,</span> <span class=n>Serializable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>final</span> <span class=n>TransactionStatus</span> <span class=n>getTransaction</span><span class=p>(</span><span class=err>@</span><span class=n>Nullable</span> <span class=n>TransactionDefinition</span> <span class=n>definition</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>throws</span> <span class=n>TransactionException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...........................</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=ne>Object</span> <span class=n>transaction</span> <span class=o>=</span> <span class=n>doGetTransaction</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>boolean</span> <span class=n>debugEnabled</span> <span class=o>=</span> <span class=n>logger</span><span class=o>.</span><span class=n>isDebugEnabled</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>No</span> <span class=n>existing</span> <span class=n>transaction</span> <span class=n>found</span> <span class=o>-&gt;</span> <span class=n>check</span> <span class=n>propagation</span> <span class=n>behavior</span> <span class=n>to</span> <span class=n>find</span> <span class=n>out</span> <span class=n>how</span> <span class=n>to</span> <span class=n>proceed</span><span class=o>.</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_MANDATORY</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>.............</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_REQUIRED</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_REQUIRES_NEW</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=n>def</span><span class=o>.</span><span class=n>getPropagationBehavior</span><span class=p>()</span> <span class=o>==</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>PROPAGATION_NESTED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>SuspendedResourcesHolder</span> <span class=n>suspendedResources</span> <span class=o>=</span> <span class=n>suspend</span><span class=p>(</span><span class=n>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=o>...............</span>
</span></span><span class=line><span class=cl>			<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>startTransaction</span><span class=p>(</span><span class=n>def</span><span class=p>,</span> <span class=n>transaction</span><span class=p>,</span> <span class=n>debugEnabled</span><span class=p>,</span> <span class=n>suspendedResources</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>catch</span> <span class=p>(</span><span class=n>RuntimeException</span> <span class=o>|</span> <span class=n>Error</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>.........</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>/**</span>
</span></span><span class=line><span class=cl>	 <span class=o>*</span> <span class=n>Start</span> <span class=n>a</span> <span class=n>new</span> <span class=n>transaction</span><span class=o>.</span>
</span></span><span class=line><span class=cl>	 <span class=o>*/</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>TransactionStatus</span> <span class=n>startTransaction</span><span class=p>(</span><span class=n>TransactionDefinition</span> <span class=n>definition</span><span class=p>,</span> <span class=ne>Object</span> <span class=n>transaction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=n>boolean</span> <span class=n>debugEnabled</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>SuspendedResourcesHolder</span> <span class=n>suspendedResources</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>boolean</span> <span class=n>newSynchronization</span> <span class=o>=</span> <span class=p>(</span><span class=n>getTransactionSynchronization</span><span class=p>()</span> <span class=o>!=</span> <span class=n>SYNCHRONIZATION_NEVER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>DefaultTransactionStatus</span> <span class=n>status</span> <span class=o>=</span> <span class=n>newTransactionStatus</span><span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=n>definition</span><span class=p>,</span> <span class=n>transaction</span><span class=p>,</span> <span class=bp>true</span><span class=p>,</span> <span class=n>newSynchronization</span><span class=p>,</span> <span class=n>debugEnabled</span><span class=p>,</span> <span class=n>suspendedResources</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>doBegin</span><span class=p>(</span><span class=n>transaction</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>prepareSynchronization</span><span class=p>(</span><span class=n>status</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DataSourceTransactionManager</span> <span class=k>extends</span> <span class=n>AbstractPlatformTransactionManager</span>
</span></span><span class=line><span class=cl>		<span class=n>implements</span> <span class=n>ResourceTransactionManager</span><span class=p>,</span> <span class=n>InitializingBean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=ne>Object</span> <span class=n>doGetTransaction</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>DataSourceTransactionObject</span> <span class=n>txObject</span> <span class=o>=</span> <span class=n>new</span> <span class=n>DataSourceTransactionObject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>txObject</span><span class=o>.</span><span class=n>setSavepointAllowed</span><span class=p>(</span><span class=n>isNestedTransactionAllowed</span><span class=p>());</span>
</span></span><span class=line><span class=cl>		<span class=n>ConnectionHolder</span> <span class=n>conHolder</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>				<span class=p>(</span><span class=n>ConnectionHolder</span><span class=p>)</span> <span class=n>TransactionSynchronizationManager</span><span class=o>.</span><span class=n>getResource</span><span class=p>(</span><span class=n>obtainDataSource</span><span class=p>());</span>
</span></span><span class=line><span class=cl>		<span class=n>txObject</span><span class=o>.</span><span class=n>setConnectionHolder</span><span class=p>(</span><span class=n>conHolder</span><span class=p>,</span> <span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>txObject</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>protected</span> <span class=n>void</span> <span class=n>doBegin</span><span class=p>(</span><span class=ne>Object</span> <span class=n>transaction</span><span class=p>,</span> <span class=n>TransactionDefinition</span> <span class=n>definition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>DataSourceTransactionObject</span> <span class=n>txObject</span> <span class=o>=</span> <span class=p>(</span><span class=n>DataSourceTransactionObject</span><span class=p>)</span> <span class=n>transaction</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>Connection</span> <span class=n>con</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>txObject</span><span class=o>.</span><span class=n>hasConnectionHolder</span><span class=p>()</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>					<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>isSynchronizedWithTransaction</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Connection</span> <span class=n>newCon</span> <span class=o>=</span> <span class=n>obtainDataSource</span><span class=p>()</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>logger</span><span class=o>.</span><span class=n>isDebugEnabled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;Acquired Connection [&#34;</span> <span class=o>+</span> <span class=n>newCon</span> <span class=o>+</span> <span class=s2>&#34;] for JDBC transaction&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>setConnectionHolder</span><span class=p>(</span><span class=n>new</span> <span class=n>ConnectionHolder</span><span class=p>(</span><span class=n>newCon</span><span class=p>),</span> <span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>setSynchronizedWithTransaction</span><span class=p>(</span><span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>con</span> <span class=o>=</span> <span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>Integer</span> <span class=n>previousIsolationLevel</span> <span class=o>=</span> <span class=n>DataSourceUtils</span><span class=o>.</span><span class=n>prepareConnectionForTransaction</span><span class=p>(</span><span class=n>con</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>setPreviousIsolationLevel</span><span class=p>(</span><span class=n>previousIsolationLevel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>setReadOnly</span><span class=p>(</span><span class=n>definition</span><span class=o>.</span><span class=n>isReadOnly</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>Switch</span> <span class=n>to</span> <span class=n>manual</span> <span class=n>commit</span> <span class=k>if</span> <span class=n>necessary</span><span class=o>.</span> <span class=n>This</span> <span class=n>is</span> <span class=n>very</span> <span class=n>expensive</span> <span class=ow>in</span> <span class=n>some</span> <span class=n>JDBC</span> <span class=n>drivers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>so</span> <span class=n>we</span> <span class=n>don</span><span class=s1>&#39;t want to do it unnecessarily (for example if we&#39;</span><span class=n>ve</span> <span class=n>explicitly</span>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>configured</span> <span class=n>the</span> <span class=n>connection</span> <span class=n>pool</span> <span class=n>to</span> <span class=n>set</span> <span class=n>it</span> <span class=n>already</span><span class=p>)</span><span class=o>.</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>con</span><span class=o>.</span><span class=n>getAutoCommit</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>setMustRestoreAutoCommit</span><span class=p>(</span><span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>logger</span><span class=o>.</span><span class=n>isDebugEnabled</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&#34;Switching JDBC Connection [&#34;</span> <span class=o>+</span> <span class=n>con</span> <span class=o>+</span> <span class=s2>&#34;] to manual commit&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>con</span><span class=o>.</span><span class=n>setAutoCommit</span><span class=p>(</span><span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>prepareTransactionalConnection</span><span class=p>(</span><span class=n>con</span><span class=p>,</span> <span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>setTransactionActive</span><span class=p>(</span><span class=bp>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=ne>int</span> <span class=n>timeout</span> <span class=o>=</span> <span class=n>determineTimeout</span><span class=p>(</span><span class=n>definition</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>timeout</span> <span class=o>!=</span> <span class=n>TransactionDefinition</span><span class=o>.</span><span class=n>TIMEOUT_DEFAULT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>()</span><span class=o>.</span><span class=n>setTimeoutInSeconds</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=o>//</span> <span class=n>Bind</span> <span class=n>the</span> <span class=n>connection</span> <span class=n>holder</span> <span class=n>to</span> <span class=n>the</span> <span class=n>thread</span><span class=o>.</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>txObject</span><span class=o>.</span><span class=n>isNewConnectionHolder</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>TransactionSynchronizationManager</span><span class=o>.</span><span class=n>bindResource</span><span class=p>(</span><span class=n>obtainDataSource</span><span class=p>(),</span> <span class=n>txObject</span><span class=o>.</span><span class=n>getConnectionHolder</span><span class=p>());</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>txObject</span><span class=o>.</span><span class=n>isNewConnectionHolder</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>DataSourceUtils</span><span class=o>.</span><span class=n>releaseConnection</span><span class=p>(</span><span class=n>con</span><span class=p>,</span> <span class=n>obtainDataSource</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=n>txObject</span><span class=o>.</span><span class=n>setConnectionHolder</span><span class=p>(</span><span class=n>null</span><span class=p>,</span> <span class=bp>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>throw</span> <span class=n>new</span> <span class=n>CannotCreateTransactionException</span><span class=p>(</span><span class=s2>&#34;Could not open JDBC Connection for transaction&#34;</span><span class=p>,</span> <span class=n>ex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=执行mybatisplus-dml与select语句>执行mybatisplus DML与Select语句</h2><p>以调用IService的saveBatch方法为例，其最初调用链路如下ServiceImpl#saveBatch -> ServiceImpl#executeBatch -> SqlHelper#executeBatch，
执行步骤如下：</p><ul><li><p>获取SqlSessionFactory</p><p>SqlHelper#executeBatch调用sqlSessionFactory方法，sqlSessionFactory对象中持有DataSource对象的引用。</p></li><li><p>调用上面一步获取的SqlSessionFactory的openSession方法（这里以DefaultSqlSessionFactory加以说明），需要注意的事这里的Transaction对象并不参与事务的执行，只是用来管理数据源，该方法执行了如下步骤：</p><ul><li>创建TransactionFactory对象</li><li>通过TransactionFactory对象创建Transaction对象，并传入从configure（SqlSessionFactory持有）对象中获取的dataScoure对象</li><li>创建Executor对象并传入Transaction对象</li><li>创建DefaultSqlSession对象并传入Executor对象</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) {
</span></span><span class=line><span class=cl>  	Transaction tx = null;
</span></span><span class=line><span class=cl>  	try {
</span></span><span class=line><span class=cl>  	final Environment environment = configuration.getEnvironment();
</span></span><span class=line><span class=cl>  	final TransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);
</span></span><span class=line><span class=cl>  	tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);
</span></span><span class=line><span class=cl>  	final Executor executor = configuration.newExecutor(tx, execType);
</span></span><span class=line><span class=cl>  	return new DefaultSqlSession(configuration, executor, autoCommit);
</span></span><span class=line><span class=cl>  	} catch (Exception e) {
</span></span><span class=line><span class=cl>  	closeTransaction(tx); // may have fetched a connection so lets call close()
</span></span><span class=line><span class=cl>  	throw ExceptionFactory.wrapException(&#34;Error opening session.  Cause: &#34; + e, e);
</span></span><span class=line><span class=cl>  	} finally {
</span></span><span class=line><span class=cl>  	ErrorContext.instance().reset();
</span></span><span class=line><span class=cl>  	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>调用SqlSession的insert方法</p><ul><li>调用链路SqlSession#insert -> SqlSession#update -> BaseExecutor#update -> BatchExecutor#doUpdate，BatchExecutor#doUpdate执行了如下步骤：<ul><li>获取Connection，调用BaseExecutor#getConnection -> Transaction.getConnection -> SpringManagedTransaction.getConnection -> SpringManagedTransaction.openConnection -> DataSourceUtils.getConnection -> DataSourceUtils.doGetConnection，从下面的代码可知道如果当前数据源绑定了Connection则获取绑定的Connection，如果没有绑定则调用DataScoure对象的getConnection方法获取新的connection方法</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static Connection doGetConnection(DataSource dataSource) throws SQLException {
</span></span><span class=line><span class=cl>	.......
</span></span><span class=line><span class=cl>	ConnectionHolder conHolder = (ConnectionHolder) TransactionSynchronizationManager.getResource(dataSource);
</span></span><span class=line><span class=cl>	if (conHolder != null &amp;&amp; (conHolder.hasConnection() || conHolder.isSynchronizedWithTransaction())) {
</span></span><span class=line><span class=cl>		conHolder.requested();
</span></span><span class=line><span class=cl>		if (!conHolder.hasConnection()) {
</span></span><span class=line><span class=cl>			logger.debug(&#34;Fetching resumed JDBC Connection from DataSource&#34;);
</span></span><span class=line><span class=cl>			conHolder.setConnection(fetchConnection(dataSource));
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>		return conHolder.getConnection();
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>	// Else we either got no holder or an empty thread-bound holder here.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	logger.debug(&#34;Fetching JDBC Connection from DataSource&#34;);
</span></span><span class=line><span class=cl>	Connection con = fetchConnection(dataSource);
</span></span><span class=line><span class=cl>	........
</span></span><span class=line><span class=cl>	return con;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private static Connection fetchConnection(DataSource dataSource) throws SQLException {
</span></span><span class=line><span class=cl>	Connection con = dataSource.getConnection();
</span></span><span class=line><span class=cl>	if (con == null) {
</span></span><span class=line><span class=cl>		throw new IllegalStateException(&#34;DataSource returned null from getConnection(): &#34; + dataSource);
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>	return con;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><ul><li>准备Statement，设置Connection为上一步获取的Connection</li><li>执行SQL语句</li></ul></li></ul></li></ul><h2 id=datascoure数据库链接的管理者>DataScoure：数据库链接的管理者</h2><p>不论是在Spring事务还是mybatisplus执行SQL语句前获取connection，都会调用DataScoure#getConnection方法。如下，DataScoure只提供了两个获取connection方法，由此可知DataScoure最主要的功能就是进行Connection的管理。对DataSource的getConnection方法提供不同的实现可以提供不同的功能，最典型的莫过于连接池和动态数据源。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=n>interface</span> <span class=n>DataSource</span>  <span class=k>extends</span> <span class=n>CommonDataSource</span><span class=p>,</span> <span class=n>Wrapper</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Connection</span> <span class=n>getConnection</span><span class=p>()</span> <span class=n>throws</span> <span class=n>SQLException</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Connection</span> <span class=n>getConnection</span><span class=p>(</span><span class=ne>String</span> <span class=n>username</span><span class=p>,</span> <span class=ne>String</span> <span class=n>password</span><span class=p>)</span> <span class=n>throws</span> <span class=n>SQLException</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=连接池>连接池</h3><p>我们以HikariCP为例，先介绍其在SpringBoot项目中如何使用，再介绍如何通过其获取Connection</p><ul><li><p>SpringBoot集成HikariCP</p><ul><li>yaml配置</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>spring:
</span></span><span class=line><span class=cl>	datasource:
</span></span><span class=line><span class=cl>	type: com.zaxxer.hikari.HikariDataSource
</span></span><span class=line><span class=cl>	url: jdbc:mysql://localhost:3306/test?useSSL=false
</span></span><span class=line><span class=cl>	username: root
</span></span><span class=line><span class=cl>	password: 123456
</span></span><span class=line><span class=cl>	driver-class-name: com.mysql.cj.jdbc.Driver
</span></span><span class=line><span class=cl>	hikari:
</span></span><span class=line><span class=cl>		pool-name: MyHikariCP
</span></span><span class=line><span class=cl>		minimum-idle: 5
</span></span><span class=line><span class=cl>		maximum-pool-size: 20
</span></span><span class=line><span class=cl>		idle-timeout: 600000
</span></span><span class=line><span class=cl>		max-lifetime: 1800000
</span></span><span class=line><span class=cl>		connection-timeout: 30000
</span></span><span class=line><span class=cl>		connection-test-query: SELECT 1
</span></span></code></pre></td></tr></table></div></div><ul><li>数据源属性类</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>@</span><span class=n>ConfigurationProperties</span><span class=p>(</span><span class=n>prefix</span> <span class=o>=</span> <span class=s2>&#34;spring.datasource&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>DataSourceProperties</span> <span class=n>implements</span> <span class=n>BeanClassLoaderAware</span><span class=p>,</span> <span class=n>InitializingBean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>ClassLoader</span> <span class=n>classLoader</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>boolean</span> <span class=n>generateUniqueName</span> <span class=o>=</span> <span class=bp>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>Class</span><span class=o>&lt;</span><span class=err>?</span> <span class=k>extends</span> <span class=n>DataSource</span><span class=o>&gt;</span> <span class=n>type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>driverClassName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>url</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>username</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=ne>String</span> <span class=n>password</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>Springboot自动配置</p><p>当我们在yaml文件中指定了<code>type: com.zaxxer.hikari.HikariDataSource</code>满足了自动配置类<code>@ConditionalOnProperty(name = "spring.datasource.type", havingValue = "com.zaxxer.hikari.HikariDataSource",matchIfMissing = true)</code>的条件，创建HikariDataSource对象并交由Spring管理。</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>stract class DataSourceConfiguration {
</span></span><span class=line><span class=cl>	@Configuration(proxyBeanMethods = false)
</span></span><span class=line><span class=cl>	@ConditionalOnClass(HikariDataSource.class)
</span></span><span class=line><span class=cl>	@ConditionalOnMissingBean(DataSource.class)
</span></span><span class=line><span class=cl>	@ConditionalOnProperty(name = &#34;spring.datasource.type&#34;, havingValue = &#34;com.zaxxer.hikari.HikariDataSource&#34;,
</span></span><span class=line><span class=cl>			matchIfMissing = true)
</span></span><span class=line><span class=cl>	static class Hikari {
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		@Bean
</span></span><span class=line><span class=cl>		@ConfigurationProperties(prefix = &#34;spring.datasource.hikari&#34;)
</span></span><span class=line><span class=cl>		HikariDataSource dataSource(DataSourceProperties properties) {
</span></span><span class=line><span class=cl>			HikariDataSource dataSource = createDataSource(properties, HikariDataSource.class);
</span></span><span class=line><span class=cl>			if (StringUtils.hasText(properties.getName())) {
</span></span><span class=line><span class=cl>				dataSource.setPoolName(properties.getName());
</span></span><span class=line><span class=cl>			}
</span></span><span class=line><span class=cl>			return dataSource;
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>HikariDataSource实现数据库链接管理
在没有创建其他数据源的情况下，HikariDataSource会被注入Mybatisplus的MybatisSqlSessionFactoryBean并在执行SQL语句前被获取，HikariDataSource只需要重写getConnection方法就可实现对数据库连接的管理。如下代码，HikariDataSource获取数据库连接的功能最终委托给了HikariPool。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>HikariDataSource</span> <span class=k>extends</span> <span class=n>HikariConfig</span> <span class=n>implements</span> <span class=n>DataSource</span><span class=p>,</span> <span class=n>Closeable</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=k>static</span> <span class=n>final</span> <span class=n>Logger</span> <span class=n>LOGGER</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>HikariDataSource</span><span class=o>.</span><span class=k>class</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>final</span> <span class=n>AtomicBoolean</span> <span class=n>isShutdown</span> <span class=o>=</span> <span class=n>new</span> <span class=n>AtomicBoolean</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>final</span> <span class=n>HikariPool</span> <span class=n>fastPathPool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>private</span> <span class=n>volatile</span> <span class=n>HikariPool</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>HikariDataSource</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>super</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>fastPathPool</span> <span class=o>=</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>HikariDataSource</span><span class=p>(</span><span class=n>HikariConfig</span> <span class=n>configuration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>configuration</span><span class=o>.</span><span class=n>validate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=n>configuration</span><span class=o>.</span><span class=n>copyStateTo</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Starting...&#34;</span><span class=p>,</span> <span class=n>configuration</span><span class=o>.</span><span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>		<span class=n>pool</span> <span class=o>=</span> <span class=n>fastPathPool</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HikariPool</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Start completed.&#34;</span><span class=p>,</span> <span class=n>configuration</span><span class=o>.</span><span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>this</span><span class=o>.</span><span class=n>seal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>	<span class=n>public</span> <span class=n>Connection</span> <span class=n>getConnection</span><span class=p>()</span> <span class=n>throws</span> <span class=n>SQLException</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>isClosed</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>throw</span> <span class=n>new</span> <span class=n>SQLException</span><span class=p>(</span><span class=s2>&#34;HikariDataSource &#34;</span> <span class=o>+</span> <span class=n>this</span> <span class=o>+</span> <span class=s2>&#34; has been closed.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>fastPathPool</span> <span class=o>!=</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>fastPathPool</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=o>//</span> <span class=n>See</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>en</span><span class=o>.</span><span class=n>wikipedia</span><span class=o>.</span><span class=n>org</span><span class=o>/</span><span class=n>wiki</span><span class=o>/</span><span class=n>Double</span><span class=o>-</span><span class=n>checked_locking</span><span class=c1>#Usage_in_Java</span>
</span></span><span class=line><span class=cl>		<span class=n>HikariPool</span> <span class=n>result</span> <span class=o>=</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>synchronized</span> <span class=p>(</span><span class=n>this</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>result</span> <span class=o>=</span> <span class=n>pool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>validate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Starting...&#34;</span><span class=p>,</span> <span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>pool</span> <span class=o>=</span> <span class=n>result</span> <span class=o>=</span> <span class=n>new</span> <span class=n>HikariPool</span><span class=p>(</span><span class=n>this</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=n>this</span><span class=o>.</span><span class=n>seal</span><span class=p>();</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>catch</span> <span class=p>(</span><span class=n>PoolInitializationException</span> <span class=n>pie</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=n>pie</span><span class=o>.</span><span class=n>getCause</span><span class=p>()</span> <span class=n>instanceof</span> <span class=n>SQLException</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=n>throw</span> <span class=p>(</span><span class=n>SQLException</span><span class=p>)</span> <span class=n>pie</span><span class=o>.</span><span class=n>getCause</span><span class=p>();</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=n>throw</span> <span class=n>pie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>LOGGER</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;{} - Start completed.&#34;</span><span class=p>,</span> <span class=n>getPoolName</span><span class=p>());</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>getConnection</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>HikariPool核心代码如下，</p></li></ul><img src=HikariDataSource.svg width=90% height=90%><h3 id=动态数据源-待补充>动态数据源 (待补充)</h3><h4 id=编译时动态>编译时动态</h4><h4 id=运行时动态>运行时动态</h4><h2 id=mybatisplus-执行-sql时数据源问题总结>mybatisplus 执行 SQL时数据源问题总结</h2><ul><li>数据源DataScoure是一个管理数据库连接的对象，它与数据库连接是一对多的关联</li><li>mybatisplus的数据源对象取自SqlSessionFactory对象，在满足第一节Mybatisplus自动配置MybatisSqlSessionFactoryBean的条件下，mybatisplus获取的是优先级最高的（加了@Primary）DataScoure对象</li><li>指定事务管理器的数据源只会影响@Transactional注解绑定Datasource对象和Connection方法的逻辑，并不会影响mybatisplus实际获取的数据源（mybatisplus从SqlSessionFactory中取数据源）</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/mybatisplus-datasource/>Mybatisplus DataSource</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2025 峰峰</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>
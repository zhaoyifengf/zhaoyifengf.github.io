---
title: "Distribution Transaction"
description: 
slug: Distribution Transaction
date: 2025-02-10T22:34:00+08:00
image: cover.png
categories:
    - Transaction
tags:
    - Transaction
weight: 1       # You can add weight to some posts to override the default sorting (date descending)
---

## 分布式事务理论知识
### CAP（Consistency、Availability、Partition Tolerance）理论
CAP理论：在分布式系统，不会同时具备CAP三个特性，只能同时具备其中两个。

1. 一致性
   
    用户对数据的写操作在所有数据副本要么都成功、要么都失败。

2. 可用性
    
    客户端访问数据时能够快速得到响应。

3. 分区容忍性
   
   分区：分布式系统中不同节点间通信出现了问题。分区容忍：在出现分区时系统仍然能对外提供服务。
   
### 为什么CAP只能满足其中两个

首先需要明确的是一个分布式系统必需要满足分区容错，也就是CAP中的P。在分布式系统中分区是一定会出现的，没有人能够保证节点与节点之间的网络总是不出问题，也没有人能够保证单个节点始终运行正常。如果一个分布式系统出现分区整个系统就停止服务，那其与单体服务并无区别（分布式系统的初衷就是通过多节点部署来提高系统的可用性）。

在出现分区的情况下，一致性与可用性只能满足其一：

1. 若要满足一致性，在对数据的多副本进行写入时需要锁定资源，而出现分区导致无法确认所有副本都写入成功，客户端的访问也无法在有效时间内得到响应。
   
2. 若要满足可可用性，对任意节点的访问都需要在指定时间得到响应，当被访问节点数据写入成功而存在节点数据未写入成功或者被访问节点数据未写入成功而其余节点数据写入成功则可用性也无法得到满足。

### BASE（Basically Available, Soft State， Eventually Consistent）理论

当出现分区时，BASE理论允许部分数据不可用，但会保证核心功能可用；允许数据在一定时间内不一致，但经过一段时间数据最终是一致的。

1. 基本可用
    
    基本可用指的是分布式系统出现故障时，允许损失部分可用性（比如响应时间或部分功能）

2. 软状态
    
    软状态指的是允许系统出现中间状态，但中中间状态不会影响系统的整体可用性。

3. 最终一致性

    最终一致性指的是允许允许数据在各个节点存在不一致，只需要数据最终一致。

## 分布式事务解决方案

### 强一致性分布式事务解决方案

强一致性事务要求任意时刻参与全局事务的各个节点的数据都一致。

### 强一致性事务的三种方案

#### 全局事务模型（DTP）

1. 基本概念
   1. 事务：一个完整的工作单元，具备ACID特性
   2. 全局事务：事务管理器管理的全局事务，能一次操作多个资源管理器
   3. 分支事务：全局事务中的每个资源管理器中独立执行的事务
   4. 控制线程：执行全局事务的线程
   
2. 执行流程
    ![](DTP.png)
    DTP模型中的三个核心组件：
    - AP（应用程序、Application Program）：参与DTP分布式事务模型的应用程序。
    - RM（资源管理器、Resource Manager）：数据库管理系统或者消息服务管理器，用来对响应的资源进行有效的控制，相应的资源需要实现XA定义的接口。
    - TM（事务管理器、Transaction Manager）：负责协调和管理DTP模型中的事务，为应用程序提供编程接口，同时管理资源管理器。

#### 二阶段提交模型（2PC）

2PC模型即两阶段提交协议模型，该模型将事务流程分为Prepare阶段和Commit阶段。

1. Prepare阶段
   
    ![](2PC_step_one.png)

    在Prepare阶段，事务管理器给每个参与全局事务的资源管理器发送Prepare消息，资源管理器要么返回失败，要么在本地执行相应的事务，将事务写入本地的Redo Log文件和Undo Log文件，但此时事务并未提交。

    如果在Prepare阶段有资源管理器返回了失败消息则在Commit阶段事务管理器会向其他响应正常消息发送回滚消息。

2.  Commit阶段
   
   ![](2PC_step_two.png)

   在2PC的commit阶段，事务管理器向参与全局事务的资源管理器发送commit消息，资源管理器收到消息后提交本地事务并将提交成功的消息返回给事务管理器。



#### 三阶段提交模型（3PC）

相比与2PC模型，3PC模型将prepare阶段分成了CanCommit阶段与PreCommit阶段。

1. CanCommit阶段

在CanCommit阶段，事务管理器会向资源管理器发送CanCommit消息，资源管理器如果认为可以执行任务则发送确认消息并进入预备状态。

![](can_commit.png)

2. PreCommit阶段

在PreCommit阶段，资源管理器接受到消息并写入undo log与redo log。

![](prepare_commit.png)

3. DoCommit阶段

![](do_commit.png)

在DoCommit阶段，资源管理器收到消息并提交事务。如果超过一定时间资源管理器没有收到事务管理器发送的事务回滚消息则会直接提交事务，如果其资源管理器收到了回滚消息则会导致数据不一致。

### 最终一致性的三种解决方案

强一致性方案要求参与事务的各个节点的数据时刻保持一致，在高并发场景下会影响性能。最新一致性方案不要求各个节点的数据始终保持一致，只要数据最终一致即可。

#### 服务模式

##### 可查询操作

![](can_search.png)

可查询操作服务模型要求操作具有唯一标识（唯一业务标识及操作时间）并且要求其他服务在提供操作接口的情况下提供查询接口及批量查询接口，在分布式环境下可以通过查询接口确认操作是否我那次。

##### 幂等操作

![](mideng.png)

幂等操作要求对于同一个方法相同的参数，操作一次和操作多次的结果相同。在分布式环境下，常常需要重试，而幂等可保证重试对最终结果没有影响。

##### TCC操作

![](TCC.png)

TCC模式包含Try，Commit，Cancel三个阶段。在try阶段完成所有业务的一致性检查、预留必要的业务资源，并需要与其他操作隔离。在Commit执行真正的业务操作。在Cancel释放预留的资源。

##### 可补偿操作


